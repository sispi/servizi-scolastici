<html @view="master.ftl">
<head @ignore>
    <base href="file:///C:/Users/daniele.damiani/Desktop/vuetest/">
    <title>viewProfile</title>
    <script src="js/vue.js"></script>
    <script src="js/axios.min.js"></script>
    <script src="vendor/jquery-3.5.1.min.js"></script>
    <script src="vendor/jquery-migrate-3.3.0.min.js"></script>
    <script>
        axios.interceptors.request.use(function(config) {
            config.headers.KS_AUTH_GROUP = "admin|ANM|ANM_AOO|SYS_ADMINS|admins";
            return config;
        });
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,700&display=swap" rel="stylesheet"><!-- Google Font Roboto-->
    <link rel="stylesheet" href="bootstrap-4.3.1-dist/css/bootstrap.min.css"><!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/base-style.css"><!-- css presonalizzato -->
    <link rel="stylesheet" href="vendor/fontawesome/all.min.css"><!-- icone -->
    <script src="vendor/moment.js"></script><!-- moment -->
    <script src="vendor/vue-scrollto.js"></script><!-- scrollto -->
    <script src="vendor/popper-1.14.7.min.js"></script>
    <script src="bootstrap-4.3.1-dist/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="css/modal-style.css">
    <script type="application/json" id="riferimenti-model" src="./static/templates/json-template/riferimenti.json"></script><!-- riferimenti in locale -->
</head>

<body class="body">
<!-- template modal component -->
<script type="x-template" id="modal-template" @server src="/static/templates/modal-template/modal-template.html"></script>
<script type="x-template" id="share-modal-template" @server src="/static/templates/modal-template/share-modal-template.html"></script>
<script type="x-template" id="history-modal-template" @server src="/static/templates/modal-template/history-modal-template.html"></script>
<script type="x-template" id="versions-modal-template" @server src="/static/templates/modal-template/versions-modal-template.html"></script>
<!--<script type="x-template" id="rif-modal-template" @server src="/static/templates/modal-template/rif-modal-template.html"></script>-->
<script type="x-template" id="reg-modal-template" @server src="/static/templates/modal-template/reg-modal-template.html"></script>
<script type="x-template" id="annullareg-modal-template" @server src="/static/templates/modal-template/annullareg-modal-template.html"></script>
<script type="x-template" id="annullaproto-modal-template" @server src="/static/templates/modal-template/annullaproto-modal-template.html"></script>
<script type="x-template" id="classifica-modal-template" @server src="/static/templates/modal-template/classifica-modal-template.html"></script>
<script type="x-template" id="edittype-modal-template" @server src="/static/templates/modal-template/edittype-modal-template.html"></script>
<script type="x-template" id="fascicola-modal-template" @server src="/static/templates/modal-template/fascicola-modal-template.html"></script>
<script type="x-template" id="nuovofascicolo-modal-template" @server src="/static/templates/modal-template/nuovofascicolo-modal-template.html"></script>
<script type="x-template" id="versioneud-modal-template" @server src="/static/templates/modal-template/versioneud-modal-template.html"></script>
<script type="x-template" id="firma-modal-template" @server src="/static/templates/modal-template/firma-modal-template.html"></script>
<script type="x-template" id="firmaremota-modal-template" @server src="/static/templates/modal-template/firmaremota-modal-template.html"></script>
<script type="x-template" id="assign-modal-template" @server src="/static/templates/modal-template/assign-modal-template.html"></script>
<script type="x-template" id="stampiglia-modal-template" @server src="/static/templates/modal-template/stampiglia-modal-template.html"></script>
<script type="x-template" id="notifiche-modal-template" @server src="/static/templates/modal-template/notifiche-modal-template.html"></script>

<script type="application/json" id="documento-model" @ftl-model="documento" @server src="/docer/v1/documenti/{DOCNUM}"></script>
<script type="application/json" id="allegati-model" @server src="/docer/v1/documenti/{DOCNUM}/related"></script>
<script type="application/json" id="messages-model" @server src="/messages?filter=viewProfile.**,label.**,common.**"></script>
<script type="application/json" id="task-model">{}</script>
<script type="application/json" id="notifiche-model">{}</script>
<script type="application/json" id="history-model">{}</script>
<script type="application/json" id="versions-model">{}</script>

<link rel="stylesheet" href="/static/css/doc-style.css">
<!--<link rel="stylesheet" href="/static/js/components/file.css?no-cache">-->

<div id="profileDocument" v-cloak>
    <br>
    <div class="card">
        <span class="page-type"><i class="bi bi-three-dots-vertical mainColor"></i>{{documento.type}}&nbsp;&nbsp;

            <template v-if="ifStamp(documento.DOCNAME)==true">
                <span class="label-info-doc stampigliato">
                    {{messages["viewProfile.stampigliato"] || "Stampigliato"}}
                </span>
            </template>
            <template v-else>
                <span v-if="documento.TIPO_COMPONENTE == 'PRINCIPALE'" class="label-info-doc principale">
                {{messages["viewProfile.principale"] || "Principale"}}
                </span>
                <span v-if="documento.TIPO_COMPONENTE == 'ANNESSO'" class="label-info-doc annesso">
                    {{messages["viewProfile.annesso"] || "Annesso"}}
                </span>
                <span v-if="documento.TIPO_COMPONENTE == 'ALLEGATO'" class="label-info-doc allegato">
                    {{messages["viewProfile.allegato"] || "Allegato"}}
                </span>
            </template>

            <template v-if="documento.TIPO_COMPONENTE!='PRINCIPALE'">
                <span v-for="(doc,i) in listaAllegati" :key="i" v-if="(doc.TIPO_COMPONENTE=='PRINCIPALE')">
                    <span style="cursor: pointer;" @click="vaiAlPrincipale(listaAllegati[i].DOCNUM)" class="label-info-doc" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.vaiAlPrincipale']||'Vai al principale' ">
                        <i class="bi bi-reply-fill mainColor"></i>
                    </span>
                </span>
            </template>
            <template v-if="documento.lockedBy">
                <span style="display: none">
                    {{documento.lockedBy}}
                </span>
                <span class="label-info-doc lock">
                    <i class="bi bi-lock-fill"></i> {{messages["viewProfile.bloccatoDa"] || "bloccato da"}} <b>{{documento.lockedBy}}</b>
                </span>
            </template>
        </span>
        <div class="card-body">
            <h5 class="card-title">
                <span v-if="estensione(documento.DOCNAME) == 'pdf'">
                    <i class="far fa-file-pdf"></i>
                </span>
                <span v-else-if="estensione(documento.DOCNAME) == 'doc' || estensione(documento.DOCNAME) == 'ocx'">
                    <i class="far fa-file-word"></i>
                </span>
                <span v-else-if="estensione(documento.DOCNAME) == 'xls'">
                    <i class="far fa-file-excel"></i>
                </span>
                <span v-else-if="estensione(documento.DOCNAME) == 'txt'">
                    <i class="far fa-file-alt"></i>
                </span>
                <span v-else-if="estensione(documento.DOCNAME) == 'p7m' || estensione(documento.DOCNAME) == 'eml'">
                    <i class="far fa-envelope-open"></i>
                </span>
                <span v-else>
                    <i class="far fa-file-code"></i>
                </span>
                {{documento.DOCNAME}} ({{documento.DOCNUM}}) <span class="size">({{bytesToSize(documento.content_size)}})</span>&nbsp;
                <i v-if="documento.NUM_PG" class="fas fa-stamp stamp" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.protocollato']||'Protocollato' " /></i>
                <i v-if="documento.N_REGISTRAZ" class="fas fa-registered stamp" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.registrato']||'Registrato' " /></i>
                <i v-if="documento.ARCHIVE_TYPE == 'PAPER'" class="fas fa-receipt stamp" style="padding-left: 7px;" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.cartaceo']||'Cartaceo' " /></i>
                <div style="margin-left: 10px;" class="btn-group float-right" role="group" aria-label="Basic example">
                    <template v-if="numNotifiche>0">
                        <button id="btn-notifiche" @click="showNotificheModal = true" type="button" class="btn btn-light" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.notifiche']||'Notifiche' "><i class="bi bi-bell mainColorDark"></i><span class="badgeNotifiche">{{numNotifiche}}</span></button>
                    </template>
                    <template v-else>
                        <button id="btn-notifiche" @click="showNotificheModal = true" style="width: 40px;" type="button" class="btn btn-light" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.notifiche']||'Notifiche' "><i class="bi bi-bell mainColorDark"></i></button>
                    </template>
                    <notifiche-modal :show="showNotificheModal" :notifiche="notifiche" @close="showNotificheModal = false"></notifiche-modal>
                    <button @click="showFirmaModal = true" style="width: 40px;" type="button" class="btn btn-light" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.verificaFirma']||'Verifica firma' " :disabled="documento.permissions.indexOf('read')==-1"><i class="bi bi-vector-pen mainColorDark"></i></button>
                    <firma-modal :show="showFirmaModal" @close="showFirmaModal = false"></firma-modal>
                    <button v-if="!documento.lockedBy" id="btnLock" @click="lockDoc()" style="width: 40px;" type="button" class="btn btn-light" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.bloccaDocumento']||'Blocca documento'" :disabled="documento.permissions.indexOf('lock')==-1"><i class="bi bi-lock mainColorDark"></i></button>
                    <button v-if="documento.lockedBy" id="btnUnlock" @click="unlockDoc()" style="width: 40px;" type="button" class="btn btn-light" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.sbloccaDocumento']||'Sblocca documento'" :disabled="documento.permissions.indexOf('unlock')==-1"><i class="bi bi-unlock mainColorDark"></i></button>
                    <button @click="rendiPrincipale(documento.DOCNUM)" type="button" class="btn btn-light" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.rendiPrincipale']||'Rendi principale' " :disabled="(documento.TIPO_COMPONENTE=='PRINCIPALE')||(documento.NUM_PG)||(documento.N_REGISTRAZ)||(documento.STATO_ARCHIVISTICO=='4')||(documento.STATO_ARCHIVISTICO=='5')||(documento.permissions.indexOf('write')==-1)"><i class="bi bi-file-earmark-ppt mainColor"></i></button>
                    <template v-if="(documento.STATO_ARCHIVISTICO==2)||(documento.STATO_ARCHIVISTICO==3)||(documento.STATO_ARCHIVISTICO==4)||(documento.STATO_ARCHIVISTICO==5)||(documento.lockedBy)">
                        <button style="width: 40px;" type="button" class="btn btn-light" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.eliminaDocumento']||'Elimina documento'" disabled><i class="bi bi-trash mainColorDark"></i></button>
                    </template>
                    <template v-else>
                        <button style="width: 40px;" @click="confirmDelete()" type="button" class="btn btn-light" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.eliminaDocumento']||'Elimina documento'" :disabled="documento.permissions.indexOf('destroy')==-1"><i class="bi bi-trash mainColorDark"></i></button>
                    </template>
                </div>
                <a v-if="listaAllegati.length > 1" v-scroll-to="'#allegati'" href="#" class="btn btn-light float-right icona-allegati" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.vaiAllegati']||'Vai agli allegati e annessi' " ><i class="bi bi-files"></i></a>
            </h5>
            <span class="tipologia-doc">{{documento.TYPE_ID}}</span>
            <template v-if="(documento.NUM_PG)||(documento.N_REGISTRAZ)||(documento.STATO_ARCHIVISTICO=='5')">
            </template>
            <template v-else>
                <button style="margin-right: -5px;" class="btn-alpha" @click="searchDocType()" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.cambiaTipologia']||'Cambia tipologia' " :disabled="documento.permissions.indexOf('write')==-1"><i style="font-size: 14px;" class="bi bi-pencil mainColor"></i></button>
                <edittype-modal :show="showEditTypeModal" :tipidoc="tipologieDocumento" @close="showEditTypeModal = false"></edittype-modal>
            </template>
            <span class="separator">|</span>
            <template v-if="documento.riferimenti">
                <a @click="openRifModalWithDocnum(getDocnumRiferimenti(documento.riferimenti))" href="#" @click.prevent="showRifModal = true" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.vediRiferimento']||'Vedi Riferimento' "><span class="rif-doc">{{messages["viewProfile.riferimenti"] || "Riferimenti"}}</span> <span class="badge badge-doc">{{calcolaNumRif(documento.riferimenti)}}</span></a>
            </template>
            <template v-else>
                <a href="#" @click.prevent="showRifModal = true" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.aggiungiRiferimenti']||'Aggiungi Riferimenti' " ><span class="rif-doc">{{messages["viewProfile.riferimenti"] || "Riferimenti"}}</span></a>
            </template>
            <rif-modal :show="showRifModal" :riferimenti="riferimentiDocumento" @close="showRifModal = false"></rif-modal>
            <div class="space-h"></div>
            <div class="btn-group" role="group" aria-label="Basic example">
                <div class="btn-group" role="group" aria-label="Button group with nested dropdown">
                    <div class="btn-group" role="group">
                        <button v-if="(!documento.SENZA_FILE)||(documento.SENZA_FILE=='false')" id="btnGroupDrop2" type="button" class="btn btn-default dropdown-toggle btn-100 btn-norightRadius" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="bi bi-file-earmark-arrow-down mainColor"></i> {{messages["viewProfile.scarica"] || "Scarica"}}</button>
                        <div class="dropdown-menu" aria-labelledby="btnGroupDrop2">
                            <button @click="downloadFile()" class="btn btn-link" :disabled="documento.permissions.indexOf('read')==-1"> {{messages["viewProfile.scaricaOriginale"] || "Scarica originale"}}</button>
                            <template v-if="estensione(documento.DOCNAME) != 'pdf'">
                                <button @click="downloadPdf()" class="btn btn-link" :disabled="documento.permissions.indexOf('read')==-1"> {{messages["viewProfile.scaricaPdf"] || "Scarica Pdf"}}</button>
                            </template>
                            <!--<template v-if="listaAllegati.length>1">-->
                            <button @click="downloadUd()" class="btn btn-link" :disabled="documento.permissions.indexOf('read')==-1"> {{messages["viewProfile.scaricaUd"] || "Scarica UD"}}</button>
                            <!--</template>-->
                            <!--
                            <button v-if="(documento.NUM_PG||documento.N_REGISTRAZ)" class="btn btn-link" href="#" @click="scaricaCopiaAnalogica()" :disabled="documento.permissions.indexOf('write')==-1">{{messages["viewProfile.scaricaCopiaAnalogica"] || "Scarica copia analogica"}}</button>
                            -->
                        </div>
                    </div>
                </div>
                <button v-if="(!documento.SENZA_FILE)||(documento.SENZA_FILE=='false')" id="showUpload" class="btn btn-default btn-100" :disabled="documento.permissions.indexOf('write')==-1"><i class="bi bi-file-earmark-arrow-up mainColor"></i> {{messages["viewProfile.carica"] || "Carica"}}</button>
                <button v-if="(!documento.SENZA_FILE)||(documento.SENZA_FILE=='false')" @click="openPreview(documento.DOCNUM, null, documento.DOCNAME, documento.url)" class="btn btn-default btn-100" :disabled="documento.permissions.indexOf('read')==-1"><i class="bi bi-box-arrow-in-up-right mainColor"></i> {{messages["viewProfile.apri"] || "Apri"}}</button>
                <button v-if="(documento.SENZA_FILE)||(documento.SENZA_FILE=='true')" id="showUploadSingle" class="btn btn-default btn-100" :disabled="documento.permissions.indexOf('write')==-1"><i class="bi bi-file-earmark-arrow-up mainColor"></i> {{messages["viewProfile.carica"] || "Carica"}}</button>
            </div>
            <button id="btn-edit" @click="showEditprofileModal = true" class="btn btn-default btn-100" :disabled="documento.permissions.indexOf('write')==-1"><i class="bi bi-pencil-square mainColor"></i> {{messages["viewProfile.modifica"] || "Modifica"}} </button>
            <editprofile-modal :show="showEditprofileModal" :tipidoc="tipologieDocumento" @close="showEditprofileModal = false"></editprofile-modal>

            <template v-if="(documento.TIPO_COMPONENTE==null)||(documento.TIPO_COMPONENTE=='PRINCIPALE')">
                <div class="btn-group" role="group" aria-label="Basic example">
                    <button id="btn-classifica" @click.prevent="showClassificaModal = true" type="button" class="btn btn-default btn-100" :disabled="documento.permissions.indexOf('write')==-1">{{messages["viewProfile.classifica"] || "Classifica"}}</button>
                    <classifica-modal :show="showClassificaModal" @close="showClassificaModal = false"></classifica-modal>
                    <button id="btn-fascicola" @click.prevent="showFascicolaModal = true" type="button" class="btn btn-default btn-100 btn-rightRadius" :disabled="documento.permissions.indexOf('write')==-1">{{messages["viewProfile.fascicola"] || "Fascicola"}}</button>
                    <fascicola-modal :show="showFascicolaModal" @close="showFascicolaModal = false"></fascicola-modal>
                </div>
                <button style="display: none;" id="btn-nuovofascicolo" @click.prevent="showNuovofascicoloModal = true" type="button" class="btn btn-default btn-100"></button>
                <nuovofascicolo-modal ref="nuovofascicolo-modal" :show="showNuovofascicoloModal" @close="showNuovofascicoloModal = false"></nuovofascicolo-modal>
                <div class="btn-group" role="group" aria-label="Basic example">
                    <button @click="searchRegistri()" class="btn btn-default btn-100" :disabled="(documento.N_REGISTRAZ)||(documento.permissions.indexOf('write')==-1)">{{messages["viewProfile.registra"] || "Registra"}}</button>
                    <reg-modal :show="showRegModal" :tipireg="tipologieRegistri" @close="showRegModal = false"></reg-modal>
                    <button @click="protocollaDoc()" class="btn btn-default btn-100" :disabled="(documento.NUM_PG)||(documento.permissions.indexOf('protocolla')==-1)">{{messages["viewProfile.protocolla"] || "Protocolla"}}</button>
                </div>
            </template>

            <button class="btn btn-default" @click="showShareModal = true"><i class="bi bi-share mainColor"></i> {{messages["viewProfile.condivisione"] || "Condivisione"}}</button>
            <share-modal :show="showShareModal" @close="showShareModal = false"></share-modal>
            <div class="btn-group" role="group" aria-label="Button group with nested dropdown">
                <div class="btn-group" role="group">
                    <button id="btnGroupDrop1" type="button" class="btn btn-primary dropdown-toggle btn-100" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">{{messages["viewProfile.azioni"] || "Azioni"}}</button>
                    <div class="dropdown-menu" aria-labelledby="btnGroupDrop1">
                        <button id="creaStampigliatura" class="btn btn-link" @click="showStampigliaModal = true" :disabled="documento.permissions.indexOf('write')==-1">{{messages["viewProfile.stampiglia"] || "Stampiglia"}}</button>
                        <button class="btn btn-link" @click="historyDoc()" href="#" @click.prevent="showHistoryModal = true" :disabled="documento.permissions.indexOf('history')==-1">{{messages["viewProfile.cronologia"] || "Cronologia"}}</button>
                        <button class="btn btn-link" @click="versionsDoc()" href="#" @click.prevent="showVersionsModal = true" :disabled="documento.permissions.indexOf('versionRead')==-1">{{messages["viewProfile.versioni"] || "Versioni"}}</button>
                        <button v-if="documento.TIPO_COMPONENTE=='PRINCIPALE'" class="btn btn-link" @click="openVersionsUDModalWithDocnum()" href="#" @click.prevent="showVersioneudModal = true" :disabled="documento.permissions.indexOf('versionWrite')==-1">{{messages["viewProfile.creaVersioneUd"] || "Crea Versione UD"}}</button>
                        <button v-if="(documento.NUM_PG||documento.N_REGISTRAZ)" class="btn btn-link" href="#" @click="creaCopiaAnalogica()" :disabled="documento.permissions.indexOf('write')==-1">{{messages["viewProfile.copiaAnalogica"] || "Copia Analogica"}}</button>
                        <button class="btn btn-link" href="#" @click.prevent="showAssignModal = true">{{messages["viewProfile.assegna"] || "Assegna"}}</button>
                        <button class="btn btn-link" href="#" @click.prevent="showFirmaremotaModal = true" :disabled="documento.permissions.indexOf('write')==-1">{{messages["viewProfile.firmaDocumento"] || "Firma documento"}}</button>
                    </div>
                    <stampiglia-modal :show="showStampigliaModal" @close="showStampigliaModal = false"></stampiglia-modal>
                    <history-modal :show="showHistoryModal" :history="historyDocumento" @close="showHistoryModal = false"></history-modal>
                    <versions-modal :show="showVersionsModal" :versions="versionsDocumento" @close="showVersionsModal = false"></versions-modal>
                    <versioneud-modal :show="showVersioneudModal" :riferimenti="versioniudDocumento" @close="showVersioneudModal = false"></versioneud-modal>
                    <assign-modal :show="showAssignModal" @close="showAssignModal = false"></assign-modal>
                    <firmaremota-modal :show="showFirmaremotaModal" @close="showFirmaremotaModal = false"></firmaremota-modal>
                </div>
            </div>
            <div class="space-h"></div>
            <!-- upload files -->
            <div style="display: none;" id="app-upload">
                <file v-on:input="addTipologiaUpload" flatten="false" id="file0" in-bg-color="lightgray" icon="fas fa-upload" v-model="files" placeholder="upload" multiple="true">
                    <template v-slot:header>
                        <span class="upl"><i class="bi bi-cloud-upload mainColor"></i> &nbsp;Clicca qui o trascina per aggiungere un file</span>
                        <hr style="margin-bottom: 0rem;">
                    </template>
                    <template slot-scope="{ file, remove, index }">
                        <table class="table table-sm table-striped">
                            <tbody>
                            <tr>
                                <td style="width: 50%">
                                    <a style="font-size: 14px;" :href="file.url">
                                        {{ file.name }} {{bytesToSize(file.size) ? '('+bytesToSize(file.size)+')' : ''}}
                                    </a>
                                </td>
                                <td style="width: 40%">
                                    <span style="font-size: 14px;" class="form-check form-check-inline" >
                                        <template v-if="index==0">
                                            <input class="form-check-input" type="radio" value="aggiungi" v-model="file.option" name="xxx">
                                            <label class="form-check-label mrg-rx">Aggiungi</label>
                                            <input class="form-check-input" type="radio" value="sostituisci" v-model="file.option" name="xxx">
                                            <label class="form-check-label mrg-rx">Sostituisci</label>
                                            <input class="form-check-input" type="radio" value="allega" v-model="file.option" name="xxx">
                                            <label class="form-check-label mrg-rx">Allega</label>
                                        </template>
                                        <template v-else>
                                            <input style="visibility: hidden" class="form-check-input" type="radio" value="aggiungi" v-model="file.option" name="yyy">
                                            <label style="visibility: hidden" class="form-check-label mrg-rx">Aggiungi</label>
                                            <input style="visibility: hidden" class="form-check-input" type="radio" value="sostituisci" v-model="file.option" name="yyy">
                                            <label style="visibility: hidden" class="form-check-label mrg-rx">Sostituisci</label>
                                            <input style="visibility: hidden" class="form-check-input" type="radio" value="allega" v-model="file.option" name="yyy">
                                            <label class="form-check-label mrg-rx">Allega</label>
                                        </template>
                                    </span>
                                </td>
                                <td style="width: 10%">
                                    <button @click="remove(file)" class="btn btn-danger" data-toggle="tooltip" data-placement="top" title="Elimina">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </template>
                    <template v-slot:footer>
                        <button style="display: none;" id="btn-uploadDoc" @click="caricaFile(files)" class="mt-2 btn btn-primary">Conferma</button>
                    </template>
                </file>
            </div>
            <div class="space-h"></div>
            <!-- upload files singolo (se documento SENZA_FILE) -->
            <div style="display: none;" id="app-upload-single">
                <file v-on:input="addTipologiaSingleUpload" flatten="false" id="file0single" in-bg-color="lightgray" icon="fas fa-upload" v-model="files" placeholder="upload">
                    <template v-slot:header>
                        <span class="upl"><i class="bi bi-cloud-upload"></i>&nbsp;Clicca qui o trascina per aggiungere un file</span>
                        <hr style="margin-bottom: 0rem;">
                    </template>
                    <template slot-scope="{ file, remove, index }">
                        <a style="font-size: 14px;" :href="file.url">- {{ file.name }} {{bytesToSize(file.size) ? '('+bytesToSize(file.size)+')' : ''}}</a>
                        <button @click="remove(file)" class="p-0 pb-1 btn btn-link" data-toggle="tooltip" data-placement="top" title="Elimina"><i style="font-size: 20px;" class="bi bi-x text-danger"></i></button>
                        <input style="display: none" class="form-check-input" type="radio" value="sostituisci" v-model="file.option">
                    </template>
                    <template v-slot:footer>
                        <button style="display: none;" id="btn-uploadNoDoc" @click="caricaFile(files)" class="mt-2 btn btn-primary">Conferma</button>
                    </template>
                </file>
            </div>
            <div class="space-h"></div>
            <div class="box-info">
                <template v-if="documento.AUTHOR_ID">
                    <div class="title-info">
                        <p class="desc-title">{{messages["viewProfile.autore"] || "Autore"}} </p>
                        <p class="desc-info">{{documento.AUTHOR_ID}}</p>
                    </div>
                </template>
                <template v-else>
                    <div class="title-info">
                        <p class="desc-title">{{messages["viewProfile.autore"] || "Autore"}} </p>
                        <p class="desc-info">{{documento.CREATOR}}</p>
                    </div>
                </template>
                <template v-if="documento.CREATION_DATE">
                    <div class="title-info">
                        <p class="desc-title">{{messages["viewProfile.creatoIl"] || "Creato il"}}</p>
                        <p class="desc-info">{{date(documento.CREATION_DATE)}} <span style="font-weight: normal;">{{messages["viewProfile.da"] || "da"}}</span> {{documento.CREATOR}}</p>
                    </div>
                </template>
                <template v-if="documento.MODIFIED">
                    <div class="title-info">
                        <p class="desc-title">{{messages["viewProfile.ultimaModifica"] || "Ultima modifica"}}</p>
                        <p class="desc-info">{{date(documento.MODIFIED)}} <span style="font-weight: normal;">{{messages["viewProfile.da"] || "da"}}</span> {{documento.MODIFIER}} </p>
                    </div>
                </template>
                <template v-if="documento.DATA_DOCUMENTO">
                    <div class="title-info">
                        <p class="desc-title">{{messages["viewProfile.dataDocumento"] || "Data documento"}}</p>
                        <p class="desc-info">{{dateNoTime(documento.DATA_DOCUMENTO)}}</p>
                    </div>
                </template>
                <template v-if="documento.STATO_ARCHIVISTICO">
                    <div class="title-info">
                        <p class="desc-title">{{messages["viewProfile.statoArchivistico"] || "Stato Archivistico"}}</p>
                        <template v-if="documento.STATO_ARCHIVISTICO > '0'">
                            <p class="desc-info">{{messages["viewProfile.definitivo"] || "Definitivo"}}</p>
                        </template>
                        <template v-else>
                            <p class="desc-info">{{messages["viewProfile.generico"] || "Generico"}}</p>
                        </template>
                    </div>
                </template>
                <template v-if="documento.COD_UO">
                    <div class="title-info">
                        <p class="desc-title">{{messages["viewProfile.ufficio"] || "Ufficio"}}</p>
                        <p class="desc-info">{{descrizione(documento.COD_UO)}}</p>
                    </div>
                </template>
                <template v-if="documento.CLASSIFICA">
                    <div class="title-info">
                        <p class="desc-title">{{messages["viewProfile.classifica"] || "Classifica Primaria"}}</p>
                        <p class="desc-info">
                            <template v-for="p in $classificaP">
                                <a style="color: #000; font-weight: normal;" :href="'/documenti/viewNaviList?entity=titolari&sid=' + documento.CLASSIFICA" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.vaiAllaClassifica']||'Vai alla Classifica' ">
                                    <strong>{{ p.text }} <i class="bi bi-reply-fill mainColor"></i></strong>
                                </a>
                            </template>
                        </p>
                    </div>
                </template>
                <template v-if="documento.PROGR_FASCICOLO">
                    <div class="title-info">
                        <p class="desc-title">{{messages["viewProfile.fascicolo"] || "Fascicolo"}}</p>
                        <p class="desc-info">
                            <template v-for="f in $fascicoloP">
                                <a style="color: #000; font-weight: normal;" :href="'/documenti/viewNaviList?entity=fascicoli&sid=' + documento.CLASSIFICA + '/' + documento.ANNO_FASCICOLO + '/' + documento.PROGR_FASCICOLO" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.vaiAlFascicolo']||'Vai al Fascicolo' ">
                                    <strong>{{documento.ANNO_FASCICOLO}}/{{documento.PROGR_FASCICOLO}} {{ f.text }} <i class="bi bi-reply-fill mainColor"></i></strong>
                                </a>
                            </template>
                        </p>
                    </div>
                </template>
                <div class="title-info" v-if="(documento.CLASS_SECONDARIE_MV)||(documento.FASC_SECONDARI)">
                    <a class="badge badge-doc btn-show" id="vediAltreInfo" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.visualizzaDettagli']||'Visualizza dettagli' " ><i class="fas fa-info"></i></a>
                </div>
            </div>
            <div class="box-info" style="display: none;" id="boxAltreInfo">
                <div v-if="documento.CLASS_SECONDARIE_MV" class="title-info">
                    <p class="desc-title">{{messages["viewProfile.classificheSecondarie"] || "Classifiche Secondarie"}}</p>
                    <p class="desc-info"></p>
                    <div style="display: inline-block; margin-right: 8px;" v-for="c in $classificheS"> {{ c.text }} </div>
                </div>
                <div v-if="documento.FASC_SECONDARI" class="title-info">
                    <p class="desc-title">{{messages["viewProfile.fascicoliSecondari"] || "Fascicoli Secondari"}}</p>
                    <p class="desc-info"></p>
                    <div style="display: inline-block; margin-right: 8px;" v-for="fs in $fascicoliS"> {{ fs.id }} {{ fs.text }} </div>
                </div>
                <div v-if="$classificheDerivate.length" class="title-info">
                    <p class="desc-title">{{messages["viewProfile.classificheDerivate"] || "Classifiche Derivate"}}</p>
                    <p class="desc-info"></p>
                    <div style="display: inline-block; margin-right: 8px;" v-for="cd in $classificheDerivate"> {{ cd.text }} </div>
                </div>
            </div>
            <div class="space-1h"></div>
            <!-- documento protocollato -->
            <template v-if="documento.NUM_PG">
                <div class="card content">
                    <div class="row col-lg-12 col-md-12 col-sm-12">
                        <div class="col-lg-8 col-md-8 col-sm-12">
                            <p class="title-proto">
                                <i class="fas fa-stamp blk"></i> {{messages["viewProfile.docProtoVerso"] || "Documento protocollato in"}} {{documento.TIPO_PROTOCOLLAZIONE|verso}}<strong> {{messages["viewProfile.num"] || "N."}} {{documento.NUM_PG}}</strong> {{messages["viewProfile.del"] || "del"}} <strong>{{date(documento.DATA_PG)}}</strong><br>
                                <template v-if="documento.NUM_PG_EMERGENZA">
                                    <span class="regEmergenza"><i class="fas fa-exclamation red"></i>{{messages["viewProfile.regEmergenza"] || "Registro Emergenza"}} {{messages["viewProfile.num"] || "N."}} {{documento.NUM_PG_EMERGENZA}} {{messages["viewProfile.del"] || "del"}} {{date(documento.DATA_PG_EMERGENZA)}}</span>
                                </template>
                            </p>
                            <p v-if="documento.OGGETTO_PG" class="desc-proto">{{messages["viewProfile.oggetto"] || "Oggetto"}}: <strong>{{documento.OGGETTO_PG}}</strong><br>
                            </p>
                            <p v-if="documento.mittente" style="margin-top: 3px;" class="desc-proto">{{messages["viewProfile.mittente"] || "Mittente"}}
                                <strong>
                                    <template v-if="documento.mittente.tipoCorrispondente">
                                        <template v-if="documento.mittente.tipoCorrispondente == 'Amministrazione'">
                                            <template v-if="documento.mittente.persona">
                                                <span class="label-mitt-dest">
                                                    <i class="fas fa-user-tie small-pad-right"></i>
                                                    {{documento.mittente.persona.denominazione}} ({{documento.mittente.denominazioneUO}})
                                                    <template v-if="documento.mittente.denominazioneAmm">
                                                        <a class="btn-icon" data-toggle="tooltip" data-placement="top" :title="documento.mittente.denominazioneAmm">
                                                            <i class="fas fa-info-circle i-icon"></i>
                                                        </a>
                                                    </template>
                                                </span>
                                            </template>
                                            <template v-else>
                                                <span class="label-mitt-dest">
                                                    <i class="fas fa-home small-pad-right"></i>
                                                    <!--{{documento.mittente.denominazioneUO ? documento.mittente.denominazioneUO : documento.mittente.denominazioneAmm}}-->
                                                    {{documento.mittente.denominazioneAmm}}
                                                    <template v-if="documento.mittente.denominazioneUO">
                                                        ({{documento.mittente.denominazioneUO}})
                                                    </template>
                                                    <template v-if="documento.mittente.indirizzoTelematico">
                                                        <a class="btn-icon" data-toggle="tooltip" data-placement="top" :title="documento.mittente.indirizzoTelematico">
                                                            <i class="fas fa-info-circle i-icon"></i>
                                                        </a>
                                                    </template>
                                                    <template v-else-if="(documento.mittente.denominazioneUO)&&(documento.mittente.denominazioneAmm)">
                                                        <a class="btn-icon" data-toggle="tooltip" data-placement="top" :title="documento.mittente.denominazioneAmm">
                                                            <i class="fas fa-info-circle i-icon"></i>
                                                        </a>
                                                    </template>
                                                </span>
                                            </template>
                                        </template>
                                        <template v-else>
                                            <span class="label-mitt-dest">
                                                <i class="fas fa-user small-pad-right"></i>
                                                {{documento.mittente.denominazione}}
                                                <template v-if="documento.mittente.indirizzoTelematico">
                                                    <a class="btn-icon" data-toggle="tooltip" data-placement="top" :title="documento.mittente.indirizzoTelematico">
                                                        <i class="fas fa-info-circle i-icon"></i>
                                                    </a>
                                                </template>
                                            </span>
                                        </template>
                                    </template>
                                </strong>
                            </p>
                            <p v-if="documento.destinatari" style="margin-top: 3px;" class="desc-proto">{{messages["viewProfile.destinatari"] || "Destinatari"}}:
                                <strong>
                                    <template v-for="destinatario in documento.destinatari">
                                        <template v-if="destinatario.tipoCorrispondente">
                                            <template v-if="destinatario.tipoCorrispondente == 'Amministrazione'">
                                                <template v-if="destinatario.persona">
                                                    <span class="label-mitt-dest">
                                                        <i class="fas fa-user-tie small-pad-right"></i>
                                                        {{destinatario.persona.denominazione}} ({{destinatario.denominazioneUO}})
                                                        <template v-if="destinatario.denominazioneAmm">
                                                            <a class="btn-icon" data-toggle="tooltip" data-placement="top" :title="destinatario.denominazioneAmm">
                                                                <i class="fas fa-info-circle i-icon"></i>
                                                            </a>
                                                        </template>
                                                    </span>
                                                </template>
                                                <template v-else>
                                                    <span class="label-mitt-dest">
                                                        <i class="fas fa-home small-pad-right"></i>
                                                        <!--{{destinatario.denominazioneUO ? destinatario.denominazioneUO : destinatario.denominazioneAmm}}-->
                                                        {{destinatario.denominazioneAmm}}
                                                        <template v-if="destinatario.denominazioneUO">
                                                            ({{destinatario.denominazioneUO}})
                                                        </template>
                                                        <template v-if="destinatario.indirizzoTelematico">
                                                            <a class="btn-icon" data-toggle="tooltip" data-placement="top" :title="destinatario.indirizzoTelematico">
                                                                <i class="fas fa-info-circle i-icon"></i>
                                                            </a>
                                                        </template>
                                                        <template v-else-if="(destinatario.denominazioneUO)&&(destinatario.denominazioneAmm)">
                                                            <a class="btn-icon" data-toggle="tooltip" data-placement="top" :title="destinatario.denominazioneAmm">
                                                                <i class="fas fa-info-circle i-icon"></i>
                                                            </a>
                                                        </template>
                                                    </span>
                                                </template>
                                            </template>
                                            <template v-else>
                                                <span class="label-mitt-dest">
                                                    <i class="fas fa-user small-pad-right"></i>
                                                    {{destinatario.denominazione}}
                                                    <template v-if="destinatario.indirizzoTelematico">
                                                        <a class="btn-icon" data-toggle="tooltip" data-placement="top" :title="destinatario.indirizzoTelematico">
                                                            <i class="fas fa-info-circle i-icon"></i>
                                                        </a>
                                                    </template>
                                                </span>
                                            </template>
                                        </template>
                                    </template>
                                </strong>
                            </p>
                            <template v-if="documento.P_ANNULL_PG">
                                <p class="label-annullamento">
                                    <span class="label label-danger"> {{messages["viewProfile.protoAnnullato"] || "PROTOCOLLAZIONE ANNULLATA"}}</span>
                                </p>
                                <p class="desc-proto">
                                    {{messages["viewProfile.motivoAnnullamento"] || "Motivazione"}}: <strong>{{documento.M_ANNULL_PG}}</strong><br>
                                </p>
                                <p class="desc-proto">
                                    {{messages["viewProfile.riferimento"] || "Riferimento"}}: <strong>{{documento.P_ANNULL_PG}}</strong> {{messages["viewProfile.del"] || "del"}} {{date(documento.D_ANNULL_PG)}} <br>
                                </p>
                            </template>
                        </div>
                        <!--<template v-if="!documento.P_ANNULL_PG">-->
                        <div class="col-lg-2 col-md-2 col-sm-12 btnCard">
                            <a @click="protocollaDoc()" class="btn btn-default btn-block">{{messages["viewProfile.dettagli"] || "Dettagli"}}</a>
                        </div>
                        <div class="col-lg-2 col-md-2 col-sm-12 btnCard">
                            <button @click="showAnnullaprotoModal = true" class="btn btn-danger btn-block">{{messages["viewProfile.annulla"] || "Annulla"}}</button>
                            <annullaproto-modal :show="showAnnullaprotoModal" @close="showAnnullaprotoModal = false"></annullaproto-modal>
                        </div>
                        <!--</template>-->
                    </div>
                </div>
            </template>
            <!-- documento registrato -->
            <template v-if="documento.N_REGISTRAZ">
                <div class="card content">
                    <div class="row col-lg-12 col-md-12 col-sm-12">
                        <div class="col-lg-10 col-md-10 col-sm-12">
                            <p class="title-proto"><i class="fas fa-registered blk"></i> {{messages["viewProfile.docRegistrato"] || "Documento registrato"}} <strong> {{messages["viewProfile.num"] || "N."}} {{documento.N_REGISTRAZ}}</strong> {{messages["viewProfile.del"] || "del"}} <strong>{{date(documento.D_REGISTRAZ)}}</strong><br></p>
                            <p class="desc-proto">{{messages["viewProfile.registro"] || "Registro"}}: <strong>{{documento.ID_REGISTRO}}</strong></p>
                            <p class="desc-proto">{{messages["viewProfile.oggetto"] || "Oggetto"}}: <strong>{{documento.O_REGISTRAZ}}</strong><br></p>
                            <template v-if="documento.P_ANNULL_REGISTRAZ">
                                <p class="label-annullamento"><span class="label label-danger"> {{messages["viewProfile.regAnnullata"] || "REGISTRAZIONE ANNULLATA"}}</span></p>
                                <p class="desc-proto">{{messages["viewProfile.motivoAnnullamento"] || "Motivazione"}}: <strong>{{documento.M_ANNULL_REGISTRAZ}}</strong><br></p>
                                <p class="desc-proto">{{messages["viewProfile.riferimento"] || "Riferimento"}}: <strong>{{documento.P_ANNULL_REGISTRAZ}}</strong> {{messages["viewProfile.del"] || "del"}} {{date(documento.D_ANNULL_REGISTRAZ)}} <br></p>
                            </template>
                        </div>
                        <template v-if="!documento.P_ANNULL_REGISTRAZ">
                            <div class="col-lg-2 col-md-2 col-sm-12 btnCard">
                                <button @click="showAnnullaregModal = true" class="btn btn-danger btn-block">{{messages["viewProfile.annulla"] || "Annulla"}}</button>
                                <annullareg-modal :show="showAnnullaregModal" @close="showAnnullaregModal = false"></annullareg-modal>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
            <!-- includo ftl relativo al tipo documento -->
            <div class="viewContainer">
                [#include ("documenti/ftl/"+ (documento.TYPE_ID!"") +"-TYPE_ID.ftl") ignore_missing=true /]
            </div>
            <!-- se presente ABSTRACT -->
            <template v-if="documento.ABSTRACT">
                <div class="card content-white">
                    <div class="row col-lg-12 col-md-12 col-sm-12">
                        <div class="col-lg-10 col-md-10 col-sm-12">
                            <p class="title-note"><i class="bi bi-sticky note"></i> <span class="title-abstract">{{documento.ABSTRACT}}</span></p>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- task -->
    <div class="space-1h"></div>
    <div style="border: 1px solid #4169e194;" v-if="task.length>0" class="card">
        <span class="page-type"><i class="bi bi-three-dots-vertical mainColor"></i>{{messages["viewProfile.task"] || "Task"}}</span>
        <div class="card-body">
            <template v-if="task.length>0">
                <div class="contentRadioCheck">
                    <div class="form-check form-check-inline">
                        <input @change="showTask()" class="form-check-input" type="radio" name="allTask" id="allTask1" value="all">
                        <label class="form-check-label" for="inlineRadio1">{{messages["viewProfile.tutti"] || "Tutti"}}</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input @change="showTask()" class="form-check-input" type="radio" name="allTask" id="allTask2" value="open" checked>
                        <label class="form-check-label" for="inlineRadio2">{{messages["viewProfile.soloAperti"] || "Solo Aperti"}}</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input @change="showTask()" class="form-check-input" type="radio" name="allTask" id="allTask3" value="completed">
                        <label class="form-check-label" for="inlineRadio3">{{messages["viewProfile.soloCompletati"] || "Solo Completati"}}</label>
                    </div>
                    <span style="margin-right: 15px;" class="separator">|</span>
                    <div class="form-check form-check-inline">
                        <input @change="showTask()" class="form-check-input" type="checkbox" id="myTask" value="option1" checked>
                        <label class="form-check-label" for="inlineCheckbox2">{{messages["viewProfile.iMieiTask"] || "I miei Task"}}</label>
                    </div>
                </div>
            </template>
            <template v-for="(t,i) in task" :key="i">
                <div class="card content-task">
                    <template v-if="t.status=='Completed'">
                        <div class="task-completed-box">
                            <div class="row col-lg-12 col-md-12 col-sm-12">
                                <div class="col-lg-12 col-md-12 col-sm-12">
                                    <p class="title-task">
                                        <span class="IdTask">
                                            <i style="color:#60bb1b;" class="fas fa-check"></i>
                                            {{messages["viewProfile.taskId"] || "Task ID"}}: <strong>{{t.id}}</strong>
                                            <span class="separator">|</span>
                                            {{messages["viewProfile.stato"] || "Stato"}}: <strong>{{t.status}}</strong>
                                            <span class="separator">|</span>
                                            {{messages["viewProfile.tipo"] || "Tipo"}}: <strong>{{t.subject}}</strong>
                                            <span class="separator">|</span>
                                            {{messages["viewProfile.avviatoIl"] || "Avviato il"}}: <strong>{{date(t.startTs)}}</strong>
                                            <span class="separator">|</span>
                                            {{messages["viewProfile.terminatoIl"] || "Terminato il"}}: <strong>{{date(t.endTs)}}</strong>
                                         </span>
                                    </p>
                                    <p class="desc-task">{{messages["viewProfile.nome"] || "Nome"}}: <strong>{{t.name}}</strong></p>
                                    <p class="desc-task">{{messages["viewProfile.descrizione"] || "Descrizione"}}: <strong>{{t.description}}</strong></p>
                                </div>
                            </div>
                        </div>
                    </template>
                    <template v-else>
                        <div class="task-box">
                            <div class="row col-lg-12 col-md-12 col-sm-12">
                                <div class="col-lg-10 col-md-10 col-sm-12">
                                    <p class="title-task">
                                        <span class="IdTask">
                                            <i class="fas fa-play mainColor"></i>
                                            {{messages["viewProfile.taskId"] || "Task ID"}}: <strong>{{t.id}}</strong>
                                            <span class="separator">|</span>
                                            {{messages["viewProfile.stato"] || "Stato"}}: <strong>{{t.status}}</strong>
                                            <span class="separator">|</span>
                                            {{messages["viewProfile.tipo"] || "Tipo"}}: <strong>{{t.subject}}</strong>
                                            <span class="separator">|</span>
                                            {{messages["viewProfile.avviatoIl"] || "Avviato il"}}: <strong>{{date(t.startTs)}}</strong>
                                         </span>
                                    </p>
                                    <p class="desc-task">{{messages["viewProfile.nome"] || "Nome"}}: <strong>{{t.name}}</strong></p>
                                    <p class="desc-task">{{messages["viewProfile.descrizione"] || "Descrizione"}}: <strong>{{t.description}}</strong></p>
                                </div>
                                <div class="col-lg-2 col-md-2 col-sm-12 btnCard">
                                    <a class="linkOpenModal" target="@modal-xl" :href="'/~task?id=' + t.id">{{messages["viewProfile.apriTask"] || "Apri Task"}}</a>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </div>
    <div style="display: none;" id="userLoggato">${utils.userInfo.username}</div>
    <!-- tabella allegati e annessi-->
    <!-- visibile solo se nella lista ci sono pi di 1 elemento, perch il primo elemento  sempre il documento attuale -->
    <div class="space-2h"></div>
    <div v-if="listaAllegati.length > 1" class="card" id="allegati">
        <span class="page-attached">{{messages["viewProfile.allegatiAnnessi"] || "Allegati e Annessi"}}</span>
        <table class="table table-sm table-striped">
            <thead>
            <tr>
                <th style="width: 45%">{{messages["viewProfile.titolo"] || "Titolo"}}</th>
                <th style="width: 20%;text-align: center;">{{messages["viewProfile.tipoDocumento"] || "Tipo documento"}}</th>
                <th style="width: 20%;text-align: center;">{{messages["viewProfile.tipoComponente"] || "Tipo componente"}}</th>
                <th style="width: 15%;text-align: center;"></th>
            </tr>
            </thead>
            <tbody>
            <tr v-for="(doc,i) in listaAllegati" :key="i" v-if="((doc.TIPO_COMPONENTE||'ALLEGATO') && (doc.DOCNUM!=documento.DOCNUM))">
                <td>
                    <span v-if="estensione(doc.DOCNAME) == 'pdf'"> <i class="far fa-file-pdf"></i></span>
                    <span v-else-if="estensione(doc.DOCNAME) == 'doc' || estensione(doc.DOCNAME) == 'ocx'"> <i class="far fa-file-word"></i></span>
                    <span v-else-if="estensione(doc.DOCNAME) == 'xls'"><i class="far fa-file-excel"></i></span>
                    <span v-else-if="estensione(doc.DOCNAME) == 'p7m' || estensione(doc.DOCNAME) == 'eml'"><i class="far fa-envelope-open"></i></span>
                    <span v-else><i class="far fa-file-code"></i></span>
                    <a :href="'/~documentoDOCNUM=' + listaAllegati[i].DOCNUM">{{ doc.DOCNAME }} ({{ doc.DOCNUM }})</a>
                </td>
                <td style="text-align: center;">
                    {{ doc.TYPE_ID }}
                </td>
                <td style="text-align: center;">
                    <template v-if="ifStamp(doc.DOCNAME)==true">
                        <span class="label-info-doc stampigliato">
                            {{messages["viewProfile.stampigliato"] || "Stampigliato"}}
                        </span>
                    </template>
                    <template v-else>
                        <!--{{ (doc.TIPO_COMPONENTE||'ALLEGATO') }}-->
                        <span v-if="doc.TIPO_COMPONENTE == 'PRINCIPALE'" class="label-info-doc principale">
                            {{messages["viewProfile.principale"] || "Principale"}}
                        </span>
                        <span v-if="doc.TIPO_COMPONENTE == 'ANNESSO'" class="label-info-doc annesso">
                            {{messages["viewProfile.annesso"] || "Annesso"}}
                        </span>
                        <span v-if="doc.TIPO_COMPONENTE == 'ALLEGATO'" class="label-info-doc allegato">
                            {{messages["viewProfile.allegato"] || "Allegato"}}
                        </span>
                    </template>
                </td>
                <td style="text-align: center;">
                    <button @click="downloadFileFromList(listaAllegati[i].DOCNUM)" type="button" class="btn-alpha" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.scarica']||'Scarica' " :disabled="documento.permissions.indexOf('read')==-1">
                        <i class="bi bi-download"></i>
                    </button>
                    <button @click="openPreview(listaAllegati[i].DOCNUM, 1, listaAllegati[i].DOCNAME, listaAllegati[i].url)" type="button" class="btn-alpha" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.apri']||'Apri' " :disabled="documento.permissions.indexOf('read')==-1">
                        <i class="bi bi-box-arrow-in-up-right"></i>
                    </button>
                    <button @click="rendiPrincipale(listaAllegati[i].DOCNUM)" type="button" class="btn-alpha" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.rendiPrincipale']||'Rendi principale' " :disabled="(listaAllegati[i].TIPO_COMPONENTE=='PRINCIPALE')||(documento.NUM_PG)||(documento.N_REGISTRAZ)||(documento.STATO_ARCHIVISTICO=='4')||(documento.STATO_ARCHIVISTICO=='5')||(documento.permissions.indexOf('write')==-1)">
                        <i class="bi bi-file-earmark-ppt"></i>
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
    <div class="space-1h"></div>
    <div style="display: none" id="modalSign" class="modal-mask">
        <div class="modal-container">
            <div class="modal-header col-md-12">
                <div class="modalTitle col-sm-12">{{messages["viewProfile.reportFirme"] || "Report Firme"}}</div>
            </div>
            <div class="modal-body modalSignContent">

            </div>
            <div class="footer-modal col-md-12 ">
                <div class="col-md-3 float-left" style="margin-left: 18px;">
                    <button type="submit" class="btn btn-default btn-block modal-btn-annulla" @click="closeFirmaModal()">{{messages["viewProfile.chiudi"] || "Chiudi"}}
                    </button>
                </div>
                <div class="col-md-3 float-right" style="margin-right: 18px;">
                    <button type="submit" class="btn btn-primary btn-block modal-btn-conferma" @click="downloadFirmaModal()"><i class="bi bi-download"></i> {{messages["viewProfile.scaricaReport"] || "Scarica Report"}}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div style="display: none" id="modalPreview" class="modal-mask">
        <div class="modal-container preview">
            <div style="padding: 10px;" class="modal-header col-md-12">
                <button id="prevPreview" @click="openPreviewPrev( $('#idDocumentoPreview').val(), $('#pagDocumentoPreview').val(), null, $('#urlDocumentoPreview').val() )" class="btn btn-default">
                    <i class="bi bi-arrow-left-circle mainColor"></i>
                </button>
                <p class="infoPages">Pag. <span id="paginaDocumento"></span> <span id="pagineTotali"></span></p>
                <button id="nextPreview" @click="openPreviewNext( $('#idDocumentoPreview').val(), $('#pagDocumentoPreview').val(), null, $('#urlDocumentoPreview').val() )" class="btn btn-default">
                    <i class="bi bi-arrow-right-circle mainColor"></i>
                </button>
                <div style="margin-left: 10px; margin-right: 10px;" class="btn-group" role="group" aria-label="Basic example">
                    <button id="zoom100Preview" @click="zoom100Preview()" class="btn btn-activeGrey">
                        <i class="bi bi-search mainColor"></i>
                    </button>
                    <button id="zoom150Preview" @click="zoom150Preview()" class="btn btn-default">
                        <i class="bi bi-zoom-in mainColor"></i>
                    </button>
                    <button id="zoom200Preview" @click="zoom200Preview()" class="btn btn-default">
                        <i class="bi bi-zoom-in mainColor"></i>
                    </button>
                </div>
                <button id="btn-downloadPreview" type="submit" class="btn btn-default" @click="downloadPreviewModal()" title="Scarica"><i class="bi bi-download mainColor"></i>
                    <div id="zoom"></div>
                    <div id="idDocumentoPreview"></div>
                    <div id="nameDocumentoPreview"></div>
                    <div id="urlDocumentoPreview"></div>
                    <div id="pagDocumentoPreview"></div>
                </button>
                <button style="display: none;" id="btn-switchPdf" @click="switchPdf($('#urlDocumentoPreview').val(), $('#idDocumentoPreview').val() )" class="btn btn-default" title="Anteprima Pdf">
                    <i class="bi bi-file-richtext mainColor"></i>
                </button>
                <button type="submit" class="btn btn-default modal-btn" @click="closePreviewModal()">{{messages["viewProfile.chiudi"] || "Chiudi"}}</button>
            </div>
            <div style="display: none" class="slidecontainer">
                <input type="range" min="1" max="100" value="1" class="slider" id="pagesSlide" @mouseup="openPreview($('#idDocumentoPreview').val(), null, $('#nameDocumentoPreview').val(), $('#urlDocumentoPreview').val())">
            </div>
            <div style="display: none; z-index: 1" class="fa fa-spinner fa-pulse fa-3x fa-fw" id="spinner"></div>
            <div style="zoom: 65%; padding-top:0px; overflow: auto;" class="modal-body modalPreviewContent">

            </div>
        </div>
    </div>

    <div style="display: none;" id="modalPreviewPdf" class="modal-mask">
        <div class="modal-container">
            <div style="padding: 10px 0px;" class="modal-header col-md-12">
                <div class="col-md-9">

                </div>
                <div class="col-md-1">
                    <button style="display: none;" id="btn-switchHtml" @click="openPreview( $('#idDocumentoPreview').val(), null, $('#nameDocumentoPreview').val(), $('#urlDocumentoPreview').val())" class="btn btn-default" title="Anteprima Html">
                        <i class="bi bi-file-code mainColor"></i>
                    </button>
                </div>
                <div class="col-md-2">
                    <button id="close-preview" type="submit" class="btn btn-default btn-block modal-btn" @click="closePreviewPdfModal()">{{messages["viewProfile.chiudi"] || "Chiudi"}}
                    </button>
                </div>
            </div>
            <div class="modal-body modalPreviewPdfContent">
                <embed class="windowPdf"
                       src=""
                       type="application/pdf"
                       frameBorder="0"
                       scrolling="auto"
                       height="625px"
                       width="600px"
                ></embed>
            </div>
        </div>
    </div>

    <!-- Modal confirm delete -->
    <div style="margin-top:64px;background: #0000005e;" class="modal fade" id="messageDeleteModal" tabindex="-1" role="dialog" aria-labelledby="messageDeleteModalLabel" aria-hidden="true" data-backdrop="false">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body msgDeleteModal">
                    <div style="text-align: center;" class="modal-body" id="messageDeleteModalTxtTitle"></div>
                    <div class="modal-body contentMsg" id="messageDeleteModalTxt"></div>
                </div>
                <row>
                    <button data-dismiss="modal" style="margin: 10px;" class="btn btn-default col-md-3">No</button>
                    <button @click="deleteDoc()" style="margin: 10px;" class="btn btn-primary col-md-3 float-right">Si</button>
                </row>
            </div>
        </div>
    </div>

</div><!-- chiusura profileDocument-->

<!-- Modal success -->
<div style="margin-top:64px;" class="modal fade" id="messageModal" tabindex="-1" role="dialog" aria-labelledby="messageModalLabel" aria-hidden="true" data-backdrop="false">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body msgModal">
                <div class="modal-body msgModalTxt" id="messageModalTxt"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal confirm cambio nome -->
<div style="margin-top:64px;background: #0000005e;" class="modal fade" id="messageChangeNameModal" tabindex="-1" role="dialog" aria-labelledby="messageChangeNameModalLabel" aria-hidden="true" data-backdrop="false">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body msgChangeNameModal">
                <div class="modal-body msgChangeNameModalTxt" id="messageChangeNameModalTxt"></div>
                <input id="newNameChangeNameModal" type="hidden">
            </div>
            <row>
                <button id="btn-annullaChangeName" data-dismiss="modal" style="margin: 10px;" class="btn btn-default col-md-3">No</button>
                <button id="btn-confermaChangeName" style="margin: 10px;" class="btn btn-primary col-md-3 float-right">Si</button>
            </row>
        </div>
    </div>
</div>

<!-- Modal anteprima mancante -->
<div style="margin-top:64px;" class="modal fade" id="anteprimaModal" tabindex="-1" role="dialog" aria-labelledby="messageModalLabel" aria-hidden="true" data-backdrop="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <div class="fas fa-exclamation-triangle mainColor allertaAnteprima"></div>
                <div class="modal-body msgModalTxt" id="anteprimaModalTxt"></div>
                <input type="hidden" id="docN">
            </div>
            <row>
                <button data-dismiss="modal" style="margin: 10px;" class="btn btn-default col-md-3">Annulla</button>
                <button id="btn-scaricaFile" style="margin: 10px;" class="btn btn-primary col-md-3 float-right">Scarica file</button>
            </row>
        </div>
    </div>
</div>

<!-- Modal confirm goTo -->
<div style="margin-top:64px;background: #0000005e;" class="modal fade" id="messageGoToModal" tabindex="-1" role="dialog" aria-labelledby="messageGoToModalLabel" aria-hidden="true" data-backdrop="false">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body msgGoToModal">
                <div style="text-align:center;" class="modal-body">Vuoi aprire l'Unit documentaria creata?</div>
                <input type="hidden" id="docNewUd">
            </div>
            <br>
            <row>
                <button data-dismiss="modal" style="margin: 10px;" class="btn btn-default col-md-3">No</button>
                <button id="btn-goToUd" style="margin: 10px;" class="btn btn-primary col-md-3 float-right">Si</button>
            </row>
        </div>
    </div>
</div>

<template id="editprofile-modal-template">
    <modal :show="show" @close="close">
        <div slot="header" class="col-md-12">
            <div class="modalTitle col-sm-12">{{messages["viewProfile.modificaDoc"] || "Modifica Documento"}}</div>
        </div>
        <div slot="body">
            <div style="display: none;" id="errMsg-editProfile" class="alert alert-danger div-alert-warning"></div>
            <label class="labelNew" style="z-index: 1;">{{messages["viewProfile.nomeDocumento"] || "Nome documento"}}</label>
            <div class="input-group mb-3">
                <input id="nameDoc" type="text" class="form-control" v-model="docnameNoEst">
                <div class="input-group-append">
                    <span class="input-group-text">.{{estensione(documento.DOCNAME)}}</span>
                </div>
            </div>
            <div class="form-group">
                <label class="labelNew">{{messages["viewProfile.descrizione"] || "Descrizione"}}</label>
                <textarea class="form-control form-control-edit" rows="2" v-model="documento.ABSTRACT"></textarea>
            </div>
            <div class="form-group" >
                <div class="row">
                    <div class="col-md-12">
                        <span class="labelNew">{{messages["viewProfile.dataDocumento"] || "Data documento"}}</span>
                        <input type="date" class="form-control form-control-edit" v-model="moment(documento.DATA_DOCUMENTO).format('YYYY-MM-DD')" v-on:input="documento.DATA_DOCUMENTO = moment($event.target.value).toISOString();"/>
                    </div>
                </div>
            </div>
            <div class="editContainer">
                [#include ("documenti/ftl/"+ (documento.TYPE_ID!"") +"-TYPE_ID.ftl") ignore_missing=true /]
            </div>
            <div class="col-md-12 footer-modal">
                <div class="col-md-3 float-left">
                    <button type="submit" class="btn btn-default btn-block modal-btn-annulla" @click="$emit('close')">{{messages["viewProfile.chiudi"] || "Chiudi"}}</button>
                </div>
                <div class="col-md-3 float-right">
                    <button type="submit" class="btn btn-primary btn-block modal-btn-conferma" @click="confermaModificaDocumento()">{{messages["viewProfile.conferma"] || "Conferma"}}</button>
                </div>
            </div>
        </div>
    </modal>
</template>


<template id="rif-modal-template">
    <modal :show="show" @close="close">
        <div slot="header" class="col-md-12">
            <div class="modalTitle col-sm-12">{{messages["viewProfile.listaRiferimenti"] || "Lista Riferimenti"}}</div>
        </div>
        <div slot="body">
            <template v-if="riferimenti.length>0">
                <div class="card">
                    <table class="table table-sm table-striped">
                        <thead>
                        <tr>
                            <th style="width: 5%; text-align: center;"></th>
                            <th style="width: 40%; text-align: center;">{{messages["viewProfile.titolo"] || "Titolo"}}</th>
                            <th style="width: 15%; text-align: center;">{{messages["viewProfile.tipo"] || "Tipo"}}</th>
                            <th style="width: 15%; text-align: center;">{{messages["viewProfile.autore"] || "Autore"}}</th>
                            <th style="width: 15%; text-align: center;">{{messages["viewProfile.ultimaModifica"] || "Ultima modifica"}}</th>
                            <th style="width: 10%; text-align: center;"></th>
                        </tr>
                        </thead>
                        <tbody v-for="(doc,i) in riferimenti" :key="i">
                        <template v-if="riferimenti" >
                            <tr>
                                <td>
                                    <input type="checkbox" :id="riferimenti[i].DOCNUM" :value="riferimenti[i].DOCNUM" name="doc" v-model="checkedRifToDelete"/>
                                </td>
                                <td style="text-transform: none;">
                                    [#include ("documenti/ftl/ICON-DOC.ftl") ignore_missing=true /]
                                    <a :href="'/documenti/viewProfile?DOCNUM=' + riferimenti[i].DOCNUM">{{ doc.DOCNAME }} ({{ doc.DOCNUM }})</a>
                                    <br>
                                    <div class="list-detail">
                                        [#include ("documenti/ftl/INFO-LIST.ftl") ignore_missing=true /]
                                    </div>
                                    <!-- mail -->
                                    <template v-if="doc.TYPE_ID == 'MAIL'">
                                        <div class="list-detail">
                                            <span class="green-title"><strong> <i class="fas fa-download"></i></strong> <span class="date-row">{{date(doc.MAIL_DATE)}}</span>
                                        </span>
                                            <br>
                                            <span class="list-detail-mail"> {{doc.MAIL_TO}} <i class="fas fa-long-arrow-alt-left"></i></strong> {{doc.MAIL_FROM}}</span>
                                            <br><span class="list-detail-object">{{doc.MAIL_SUBJECT}}</span>
                                        </div>
                                    </template>
                                </td>
                                <td style="text-align: center;">
                                    {{ doc.TYPE_ID }}
                                </td>
                                <td style="text-transform: none; text-align: center;">
                                    {{ doc.CREATOR }}
                                </td>
                                <td>
                                    {{date(doc.ULTIMA_MODIFICA)}}
                                </td>
                                <td style="text-align: center;">
                                    <a :href="'/docer/v1/documenti/' + riferimenti[i].DOCNUM + '/file'" class="btn-icon" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.scarica']||'Scarica' " ><i style="padding-right: 0px;" class="bi bi-download mainColor"></i></a>
                                    <!--<a @click="getDocnumRifToDelete(riferimenti[i].DOCNUM)" class="btn-icon" data-toggle="tooltip" data-placement="top" :title=" messages['viewProfile.elimina']||'Elimina' "><i style="color: red;" class="bi bi-x-circle"></i></a>-->
                                </td>
                            </tr>
                        </template>
                        </tbody>
                    </table>
                </div>
                <div class="space-h"></div>
                <button class="btn btn-danger modal-btn-default" @click="getMultiDocnumRifToDelete()">{{messages["viewProfile.eliminaSelezionati"] || "Elimina selezionati"}}</button>
            </template>
            <template v-else>
                <div class="noElementTable">
                    <span>{{messages["viewProfile.nessunRiferimentoPresente"] || "Nessun riferimento presente"}}</span>
                </div>
            </template>
            <hr>
            <div class="row">
                <span class="labelNew autocomplete">{{messages["viewProfile.documenti"] || "Documenti"}}</span>
                <!--<div class="col-md-12" v-if="model">-->
                <div class="col-md-12">
                    <select2 :value="list" v-on:changed="list=$event.ids" class="form-control" url="/docer/v1/solr/select?database=false&fq=type:documento&wt=json&fl=sid,text:name&q=name:%24%7Bterm%7D OR DOCNUM:%24%7Bterm%7D OR DOCNAME:*/%24%7Bterm%7D&term=..." multiple="true"></select2>
                </div>
            </div>

            <div class="col-md-12 footer-modal">
                <div class="col-md-3 float-left">
                    <button type="submit" class="btn btn-default btn-block modal-btn-annulla" @click="$emit('close')">{{messages["viewProfile.chiudi"] || "Chiudi"}}</button>
                </div>
                <div class="col-md-3 float-right">
                    <button type="submit" class="btn btn-primary btn-block modal-btn-conferma" @click="aggiungiRiferimenti(list)">{{messages["viewProfile.aggiungiRiferimenti"] || "Aggiungi riferimenti"}}</button>
                </div>
            </div>
        </div>
    </modal>
</template>


<div style="display: none;" id="id-reload"></div>

<script @ignore>
    function template(template) {
        return "#"+template;
    }
</script>

<script @ignore>
    $("script[type='x-template'][src]").each(function() {
        var elem = $(this);
        $.ajax({
            url : "."+elem.attr('src'),
            async : false,
            type : "GET",
            success : function(data, textStatus){
                elem.html(data);
            },
            error : function(xhr, status, error){
                elem.html(xhr.responseText);
            }
        });
    });
</script>

<script @ignore>
    $("script[type='application/json'][src]").each(function() {
        var elem = $(this);
        var src = elem.attr('src');
        var properties = false;

        if(src=="/messages?filter=viewProfile.**,label.**,common.**"){
            src="./static/messages.properties";
            properties = true;
        }
        if(src=="/docer/v1/documenti/{DOCNUM}"){
            src="./static/templates/json-template/documento.json";
        }
        if(src=="/docer/v1/documenti/{DOCNUM}/related"){
            src="./static/templates/json-template/allegati.json";
        }
        /*
        if(src=="/tempRiferimenti"){
            src="./static/templates/json-template/riferimenti.json";
        }
        if(src=="/tempTask"){
            src="./static/templates/json-template/task.json";
        }*/

        $.ajax({
            url : src,
            async : false,
            type : "GET",
            success : function(data, textStatus){
                if (properties){
                    var map = {};
                    data.split(/[\r\n]+\s*/).forEach( line=>  map[line.split("=")[0]] = line.split("=")[1] )
                    data = JSON.stringify(map,null,4);
                }
                elem.html(data);
            },
            error : function(xhr, status, error){
                if (properties){
                    var map = {};
                    data.split(/[\r\n]+\s*/).forEach( line=>  map[line.split("=")[0]] = line.split("=")[1] )
                    data = JSON.stringify(map,null,4);
                }
                elem.html(xhr.responseText);
            }
        });
    });
</script>

<script >
    var ks6smistamento = '${utils.getProperty("bpm.smistamento","ks6smistamento1.9")}';
    var stampigliaturaProt = '${utils.getProperty("stampigliatura.prot","")}';
    var stampigliaturaReg = '${utils.getProperty("stampigliatura.reg","")}';
    var stampigliaturaProtReg = '${utils.getProperty("stampigliatura.protReg","")}';
    var stampigliaturaPosizione = '${utils.getProperty("stampigliatura.posizione","alto")}';

    //variabili globali
    Vue.prototype.$classificaP = [{}];
    Vue.prototype.$classificheS = [{}];
    Vue.prototype.$fascicoliDocumento = [];
    Vue.prototype.$fascicoloP = [];
    Vue.prototype.$fascicoliS = [];
    Vue.prototype.$classificheDerivate = [];
    //recupero user loggato temporanemente con un campo nascosto nell'Html in cui ho inserito ${utils.userInfo.username}
    Vue.prototype.$userLoggato = $('#userLoggato').text().trim();

    //metodi globali
    Vue.mixin({
        computed: {
            docnameNoEst: {
                get(){
                    //in questa funzione elimino l'estensione del file ed  visbile nell'input
                    return this.documento.DOCNAME.split('.').slice(0, -1).join('.');
                },
                set(nuovoNome){
                    //recupero l'estesione del file
                    var estensione = this.documento.DOCNAME.replace(/^.*\./, '');
                    //imposto il nuovo nome immesso concatenando l'estensione originale recuperata
                    this.documento.DOCNAME = nuovoNome+"."+estensione;
                }
            }
        },
        methods: {
            bytesToSize: function (bytes) {
                var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                if (bytes == 0) return '0 Byte';
                var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
                return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
            },
            moment: function(date) {
                return moment(date);
            },
            date: function(date) {
                return moment(date).format('DD/MM/YYYY HH:mm:ss');
            },
            dateNoTime: function(date) {
                return moment(date).format('DD/MM/YYYY');
            },
            estensione: function(text) {
                if (text) {
                    return text.replace(/^.*\./, '');
                }
            },
            ifStamp: function(text) {
                if (text.includes("STAMP_")) {
                    return true;
                } else {
                    return false;
                }
            },
            descrizione: function(text) {
                return ("Descrizone ") + ("(") + text + (")");
            },

            //inizio anteprima file
            mouseLeave: function() {
                this.openPreview();
            },
            ifIsPdf: function (text) {
                if (text.substring(text.toLowerCase().lastIndexOf(".")+1)=="pdf"){
                    $("#btn-switchPdf").show();
                    $("#btn-switchHtml").show();
                } else {
                    $("#btn-switchPdf").hide();
                    $("#btn-switchHtml").hide();
                }
            },
            switchPdf: function(url, docnum) {
                $("#modalPreview" ).hide();
                $(".modalPreviewContent").empty();
                $("#pagesSlide").val("1");
                $("#paginaDocumento").text("1");
                this.zoom100Preview();
                if(docnum){
                    if(!url){
                        url = $("#urlDocumentoPreview").val();
                    }
                    var host= url.substr(0, url.indexOf('documenti'));
                    var urlToConvert = host+"documenti/"+docnum+"/file";
                    var url_doc = encodeURIComponent(urlToConvert);
                    axios.get("/docer/v1/firma/print?urls="+url_doc)
                        .then(response => {
                            if(response.status==200){
                                var url = response.data[0];
                                // l'url per l'anteprima deve essere in questo formato
                                //"/docer/v1/files/upload$aoo_test,admin@ea7fc7a4-06b8-4c9d-b6d9-8594b102b5e5$file_signed.pdf?inline=true&ct=application/pdf";
                                this.openPdfPreview(url);
                                this.close();
                            }
                        })
                        .catch(error => {
                            if(error.response){
                                showError(error.response.data);
                            }
                        });
                } else {
                    this.openPdfPreview(url);
                }
            },
            openPdfPreview: function(url){
                //var url = decodeURIComponent(url);
                var urlNoHost = url.split('files')[1];
                var urlToDownload = "/docer/v1/files"+urlNoHost+"?inline=true&ct=application/pdf";
                $('embed').replaceWith($('embed').clone().attr('src',urlToDownload+"#zoom=50"));
                $("#modalPreviewPdf").show();
            },
            openPreviewPrev: function(docnum, pag, docname, url) {
                if(pag!=1){
                    pag--;
                }
                this.openPreview(docnum, pag, docname, url);
            },
            openPreviewNext: function(docnum, pag, docname, url) {
                pag++;
                this.openPreview(docnum, pag, docname, url);
            },
            openPreview: function(docnum, pag, docname, url) {
                if(docname){
                    if(typeof nomeStampigliato !== 'undefined'){
                        docname=nomeStampigliato;
                    }
                    this.ifIsPdf(docname); //se pdf abilito tasto switch anteprima pdf
                }
                $("#spinner").show();
                $('.modalPreviewContent').css({"background-color": "#dedede"});
                if(pag){
                    var numPage = pag;
                    $("#pagesSlide").val(pag);
                } else {
                    var numPage = $("#pagesSlide").val();
                }
                var params = {
                    //paperWidth: '8.27',
                    //paperHeight: '11.69',
                    //marginTop: '0',
                    //marginBottom: '0',
                    //marginLeft: '0',
                    //marginRight: '0',
                    //landscape: 'true',
                    //scale: '0.75',
                    pageRanges: numPage,
                    ft: 'html',
                }
                var data = new URLSearchParams(params).toString();
                if ($("#modalPreview").is(':visible')) { //se la modale  aperta aggiungo #nopanel per non far partire il refres pagina
                    data+= "#nopanel";
                }
                if(docnum){
                    var converti = "/bl/v1/convert?docnum="+docnum+"&"+data;
                    var fromUrl = "";
                }else{
                    if(!url){
                        url =  $("#urlDocumentoPreview").val();
                    }
                    var converti = "/bl/v1/convert?url="+url+"&"+data;
                }
                axios.post(converti)
                    .then(response => {
                        $("#spinner").hide();
                        $('.modalPreviewContent').css({"background-color": "#fff"});

                        if( $("#modalPreviewPdf").is(':visible') ) {
                            $("#modalPreviewPdf").hide();
                        }

                        if(response.status==200) {
                            if(response.data.status==200){
                                $("#nextPreview").removeAttr("disabled");
                                var totalPages = response.data.file.totalPages ? response.data.file.totalPages : "1";
                                $("#pagesSlide").attr({
                                    "max" : totalPages,
                                    "min" : 1
                                });

                                $("#paginaDocumento").val(numPage).html(numPage);
                                $("#pagineTotali").text("di " +totalPages);
                                if (totalPages!=1){
                                    $(".slidecontainer, #pagineTotali").show();
                                } else {
                                    $(".slidecontainer, #pagineTotali").hide();
                                }
                                if(numPage!=1 && numPage==totalPages){
                                    $("#nextPreview").attr("disabled", true);
                                }

                                console.log(response.data.file);
                                var absoluteUri = response.data.file.uri;
                                var relativeUri = "/docer/v1/"+absoluteUri.replace(/^(?:\/\/|[^/]+)*\//, '');

                                const config = { responseType: 'stream' };
                                axios.get(relativeUri+"#nopanel", config)
                                    .then(response => {
                                        if(response.status==200){
                                            if ( !$("#modalPreview").is(':visible') ){
                                                $("#modalPreview").show();
                                            }
                                            $(".modalPreviewContent").empty();
                                            $(".modalPreviewContent").append(response.data);
                                            if($('#zoom').val() == 100){
                                                this.zoom100Preview();
                                            }
                                            if($('#zoom').val() == 150){
                                                this.zoom150Preview();
                                            }
                                            if($('#zoom').val() == 200){
                                                this.zoom200Preview();
                                            }
                                            $("#idDocumentoPreview").val(docnum);
                                            $("#nameDocumentoPreview").val(docname);
                                            //se non ho il docnum (doc stampigliato non annesso) non lo posso scaricare dall'anteprima
                                            if ($("#idDocumentoPreview").val()!=""){
                                                $("#btn-downloadPreview").show();
                                            } else {
                                                $("#btn-downloadPreview").hide();
                                            }

                                            $("#urlDocumentoPreview").val(url);
                                            $("#pagDocumentoPreview").val(numPage);

                                            if (numPage==1){
                                                $("#prevPreview").attr("disabled", true);
                                            } else {
                                                $("#prevPreview").removeAttr("disabled");
                                            }
                                            //se conversione html non crea div page_0, disabilito tasto nextPage
                                            if( $("#page_0").length === 0 ){
                                                $("#nextPreview").attr("disabled", true);
                                            } else {
                                                $("#nextPreview").removeAttr("disabled");
                                            }
                                        }
                                    })
                                    .catch(error => {
                                        alert("<b>"+response.data.status + "</b>: " + response.data.message);
                                    });
                            } else {
                                console.log(response.data.status + " " + response.data.message);
                                if( !$("#modalPreview").is(':visible') ){ //apro finestra anteprima solo se la finestra anteprima non  aperta
                                    openAnteprimaModal("Anteprima non disponibile",docnum);
                                } else {
                                    $("#nextPreview").attr("disabled", true); //disabilito tasto pag+
                                }
                            }
                        } else {
                            if( !$("#modalPreview").is(':visible') ) { //apro finestra anteprima solo se la finestra anteprima non  aperta
                                openAnteprimaModal("Anteprima non disponibile",docnum);
                            } else {
                                alert("<b>"+response.data.status + "</b>: " + response.data.message);
                            }
                        }
                    })
                    .catch(error => {
                        if(typeof response !== "undefined"){
                            alert("<b>"+response.data.status + "</b>: " + response.data.message);
                        }else{
                            alert("Servizio temporanemente non disponibile \n" + "<b>"+error.name + "</b>: " + error.message);
                        }
                    });
            },
            zoom100Preview: function() {
                $('#zoom100Preview').removeClass("btn-default").addClass("btn-activeGrey");
                $('#zoom150Preview, #zoom200Preview').removeClass("btn-activeGrey").addClass("btn-default");
                $('.page').css({"zoom": "98%", "-moz-transform": "scale(0.9)", "-moz-transform-origin": "top center"}).removeClass("pageZoom150").removeClass("pageZoom200").addClass("pageZoom100");
                $('#zoom').val("100");
            },
            zoom150Preview: function() {
                $('#zoom150Preview').removeClass("btn-default").addClass("btn-activeGrey");
                $('#zoom100Preview, #zoom200Preview').removeClass("btn-activeGrey").addClass("btn-default");
                $('.page').css({"zoom": "130%", "-moz-transform": "scale(1.3)", "-moz-transform-origin": "top center"}).removeClass("pageZoom100").removeClass("pageZoom200").addClass("pageZoom150");
                $('#zoom').val("150");
            },
            zoom200Preview: function() {
                $('#zoom200Preview').removeClass("btn-default").addClass("btn-activeGrey");
                $('#zoom100Preview, #zoom150Preview').removeClass("btn-activeGrey").addClass("btn-default");
                $('.page').css({"zoom": "180%", "-moz-transform": "scale(1.8)", "-moz-transform-origin": "top center"}).removeClass("pageZoom100").removeClass("pageZoom150").addClass("pageZoom200");
                $('#zoom').val("200");
            },
            closePreviewModal: function() {
                $("#modalPreview" ).hide();
                $(".modalPreviewContent").empty();
                $("#pagesSlide").val("1");
                $("#paginaDocumento").text("1");
                this.zoom100Preview();
                if ($("#id-reload").val()=="reload"){
                    openMessageModal("Stampigliato creato con successo!");
                }
            },
            closePreviewPdfModal: function() {
                $( "#modalPreviewPdf" ).hide();
                if ($("#id-reload").val()=="reload"){
                    openMessageModal("Stampigliato creato con successo!");
                }
            },
            downloadPreviewModal: function() {
                var IdToDownload = $('#idDocumentoPreview').val();
                window.location.href = "/docer/v1/documenti/"+IdToDownload+"/file";
            },
            //fine anteprima file
        },
        filters: {
            verso: function(text) { //verso protocollazione
                if (text == "U") {
                    text = "Uscita"
                }
                if (text == "E") {
                    text = "Entrata"
                }
                if (text == "I") {
                    text = "Interna"
                }
                return text;
            },
            uppercase: function(text) {
                return text.toUpperCase()
            },
            wrapText: function(text) { //br body email
                if(text){
                    let a = text.split('\n');
                    let str = '';
                    for (let x = 0; x < a.length; x++) {
                        str += a[x];
                        if (x % 2 == 0) {
                            if (x < a.length - 1)
                                str += '<br>';
                        } else {
                            str += '</br>';
                        }
                    }
                    return str
                }
            },
            limitText30: function(text) {
                if(text.length > 30)
                    text = text.substring(0,30) + '...';
                return text
            },
        }
    })


    //modale
    Vue.component('Modal', {
        template: template('modal-template'),
        props: ['show'],
        data: function() {
            return {
                messages: data("messages-model"),
            };
        },
        methods: {
            close: function() {
                this.$emit('close');
            }
        },
        mounted: function() {
            document.addEventListener("keydown", (e) => {
                if (this.show && e.keyCode == 27) {
                    this.close();
                }
            });
        }
    });

    //C-CONDIVISIONE
    var shareNodalApp = Vue.component('ShareModal', {
        template: template('share-modal-template'),
        props: ['show'],
        data: function() {
            var messages = data("messages-model");
            var url = "\n"+window.location.href;
            return {
                addUser: '',
                documento: data("documento-model"),
                messages: messages,
                listaAllegati: data("allegati-model"),
                checkedFiles:[data("documento-model").DOCNUM],//imposto il documento corrente
                destinatariInterni:[],
                oggettoMailCondividi: messages['viewProfile.oggettoMailCondividi']||'Oggetto Mail',
                bodyMailCondividi: (messages['viewProfile.bodyMailCondividi']||'Testo Mail')+url,
                oggettoMailInvia: messages['viewProfile.oggettoMailInvia']||'Oggetto Mail',
                bodyMailInvia: messages['viewProfile.bodyMailInvia']||'Testo Mail',
                mezzo:"PEO",
                userAcl:[],
                dirittiAcl:[],
                tags:[],
                nuoveAcl:[],
                options: [
                    { text: 'Conoscenza', value: 'readOnly' },
                    { text: 'Competenza', value: 'normalAccess' },
                    { text: 'Gestione', value: 'fullAccess' }
                ],
                aclEreditati:{},

                userOrGroup:[],
                aclUserOrGroup:[],
                flascicoloOrDocument:[],
                fascicoloForUrl: [],
                dirittiUser: messages['viewProfile.aclEreditatiDefault']||'Non hai diritti su questo documento',
            };
        },
        created() {
            if(documento.acl_explicit){
                for (var i = 0; i < documento.acl_explicit.length; i++) {
                    var utente = documento.acl_explicit[i].split("@")[0];
                    //recupero diritti relativi all'utente loggato
                    if(utente == this.$userLoggato){
                        var dirittiUserLoggato = documento.acl_explicit[i].split(":").pop();
                        if(dirittiUserLoggato=="readOnly"){
                            this.dirittiUser="Conoscenza"
                        }
                        if(dirittiUserLoggato=="normalAccess"){
                            this.dirittiUser="Competenza"
                        }
                        if(dirittiUserLoggato=="fullAccess"){
                            this.dirittiUser="Gestione"
                        }
                    };
                    var diritti = documento.acl_explicit[i].split(":").pop();
                    this.userAcl.push( utente );
                    this.dirittiAcl.push( diritti );
                    this.nuoveAcl.push( diritti );
                }
            }
            if(documento.inherited){
                for (chiave in documento.inherited){
                    if (chiave.indexOf(documento.DOCNUM)==-1){ //non considero i diritti del documento attuale
                        if(!(chiave in this.aclEreditati)){
                            var chiavePulita = chiave.split('!').pop().split('@')[0].replaceAll("|","/");
                            var fasc = chiave.split('!').pop().split('@')[0];
                            var chiaveUrl = encodeURIComponent(fasc);
                            this.aclEreditati[chiavePulita]={};
                        }
                        var aclFascicolo = this.aclEreditati[chiavePulita];
                        var lista = documento.inherited[chiave];
                        for (var i = 0; i < lista.length; i++) {
                            var utente = lista[i].split("@")[0];
                            if(!(utente in aclFascicolo)){
                                aclFascicolo[utente]=[];
                            }
                            var diritto = lista[i].split(":").pop();
                            var listaAcl = aclFascicolo[utente];
                            if(!(listaAcl.includes(diritto))){
                                listaAcl.push(diritto);
                            }
                            this.userOrGroup.push(utente);
                            this.aclUserOrGroup.push(diritto);
                            this.flascicoloOrDocument.push(chiavePulita);
                            this.fascicoloForUrl.push(chiaveUrl);
                        }
                    }
                }
            }
        },
        methods: {
            decodeTxt: function (text) {
                var uri_dec = decodeURIComponent(text);
                return uri_dec;
            },
            encodeTxt: function (text) {
                var uri_enc = encodeURIComponent(uri);
                return uri_enc;
            },
            aclIta: function (text) {
                if(text=="readOnly"){
                    text="Conoscenza"
                }
                if(text=="normalAccess"){
                    text="Competenza"
                }
                if(text=="fullAccess"){
                    text="Gestione"
                }
                return text;
            },
            addUtente: function () {
                this.userAcl.push( '' );
                this.dirittiAcl.push( 'readOnly' );
                this.nuoveAcl.push( 'readOnly' );
            },
            deleteUtente: function (index) {
                this.userAcl.splice(index, 1);
                this.dirittiAcl.splice(index, 1);
                this.nuoveAcl.splice(index, 1);
            },
            showShare: function(){
                $("#shareDoc").show();
                $("#sendLink, #sendDoc").hide();
                $("#btnShare").removeClass("btn-default").addClass("btn-primary");
                $("#btnSendLink, #btnSendDoc").removeClass("btn-primary").addClass("btn-default");
                $("#errMsg-sendLink, #errMsg-sendDoc, #errMsg-share").hide();
            },
            showSendLink: function(){
                $("#sendLink").show();
                $("#shareDoc, #sendDoc").hide();
                $("#btnSendLink").removeClass("btn-default").addClass("btn-primary");
                $("#btnShare, #btnSendDoc").removeClass("btn-primary").addClass("btn-default");
                $("#errMsg-sendLink, #errMsg-sendDoc, #errMsg-share").hide();
            },
            showSendDoc: function(){
                $("#shareDoc, #sendLink").hide();
                $("#sendDoc").show();
                $("#btnSendDoc").removeClass("btn-default").addClass("btn-primary");
                $("#btnShare, #btnSendLink").removeClass("btn-primary").addClass("btn-default");
                $("#errMsg-sendLink, #errMsg-sendDoc, #errMsg-share").hide();
            },
            close: function() {
                this.$emit('close');
                this.addUser = ''; //quando esco dal modale cancello il testo inserito nell'input v-model="addUser"
            },
            confermaCondivisione: function() {
                if ($("#shareDoc").is(':visible')) {
                    $("#errMsg-acl").hide().text("");
                    for (i = 0; i < this.userAcl.length; i++) {
                        console.log(this.userAcl[i]);
                        if (this.userAcl[i] == "") {
                            $("#errMsg-acl").show().append('<p class="info-error">utente o gruppo mancante!</p>');
                            return false;
                        }
                    }

                    var a = this.userAcl;
                    var b = this.nuoveAcl;
                    //var b = this.dirittiAcl;
                    //unisco i valori dei 2 array per posizione
                    function merge(a, b) {
                        if (a.length == b.length) {
                            var c = [];
                            for (var i = 0; i < a.length; i++) {
                                c.push([a[i], b[i]]);
                            }
                            return c;
                        }
                        return null;
                    }
                    var c = merge(a, b);
                    //dall'array mergiato unisco le prime 2 posizioni divise da :
                    var nuoveAcl = [];
                    for (var w = 0; w < c.length; w++) {
                        d = c[w].toString();
                        e = d.replace(",",":");
                        nuoveAcl.push(e);
                    }

                    var docerClient = new DocerClient();
                    var payload = {
                        acl_explicit: nuoveAcl,
                    }

                    var path = this.documento.DOCNUM;
                    docerClient.documenti.update(path, payload, (data)=>{
                        openMessageModal("Diritti aggiornati con successo!");
                    });

                    this.close();
                }
                if ($("#sendLink").is(':visible')) {
                    $("#errMsg-sendLink").hide().text("");
                    if(this.destinatariInterni==""){ //vuoto se cancelli voci inserite
                        $("#errMsg-sendLink").show().append('<p class="info-error">destinatari mancanti!</p>');
                    } else {
                        var payload = {
                            processId: ks6smistamento,
                            input: {
                                "docnum" : this.documento.DOCNUM,
                                "conoscenti" : this.destinatariInterni,
                                "subject" : this.oggettoMailCondividi,
                                "body" : this.bodyMailCondividi
                            }
                        }
                        axios.post("/bpm/v1/instances", payload)
                            .then(response => {
                                if(response.status==201){
                                    this.close();
                                    openMessageModal("Documento condiviso con successo!");
                                }
                            }).catch(error => {
                            showError(error.response.data);
                        });
                        this.close();
                    }
                }
                if ($("#sendDoc").is(':visible')) {
                    //var regexmail = /^([a-zA-Z0-9_\-\.]+)@([a-zA-Z0-9_\-\.]+)\.([a-zA-Z]{2,5})$/;
                    $("#errMsg-sendDoc").hide().text("");
                    if(this.tags.length == 0){
                        $("#errMsg-sendDoc").show().append('<p class="info-error">destinatari mancanti!</p>');
                    } else {
                        if(this.checkedFiles.length == 0){
                            $("#errMsg-sendDoc").show().append('<p class="info-error">selezionare almeno 1 documento da inviare!</p>');
                        }else{
                            var attachments = [];
                            for (var i = 0; i < this.checkedFiles.length; i++) {
                                attachments.push("http://localhost:8080/documenti/"+this.checkedFiles[i]+"/file");
                            }
                            var payload = {
                                email: true,
                                subject: this.oggettoMailInvia,
                                body: this.bodyMailInvia,
                                priority: false,
                                toRecipients: this.tags,
                                attachments: attachments
                                //contextVariables: { "name": "Mario Rossi" }
                            }
                            axios.post("/bpm/v1/notifications", payload)
                                .then(response => {
                                    if(response.status==201){
                                        //this.documento = response.data;
                                        this.close();
                                        openMessageModal("Documento inviato con successo!");
                                    }
                                }).catch(error => {
                                showError(error.response.data);
                            });
                            this.close();
                        }
                    }
                }
            }
        }
    });

    //C-ASSEGNA
    Vue.component('AssignModal', {
        template: template('assign-modal-template'),
        props: ['show'],
        data: function() {
            var messages = data("messages-model");
            return {
                documento: data("documento-model"),
                messages: messages,
                competente:[],
                conoscenti:[],
                oggettoMailAssegna: messages['viewProfile.oggettoMailAssegna']||'Oggetto Mail',
                bodyMailAssegna: messages['viewProfile.bodyMailAssegna']||'Testo Mail',
            };
        },
        methods: {
            close: function() {
                this.$emit('close');
            },
            confermaAssegna: function() {
                $("#errMsg-assign").hide().text("");
                if(this.competente.length==0){
                    $("#errMsg-assign").show().append('<p class="info-error">destinataro mancante!</p>');
                } else {
                    var payload = {
                        processId: ks6smistamento,
                        input: {
                            "docnum" : this.documento.DOCNUM,
                            "assegnatari" : this.competente,
                            "conoscenti" : this.conoscenti,
                            "subject" : this.oggettoMailAssegna,
                            "body" : this.bodyMailAssegna
                        }
                    }
                    axios.post("/bpm/v1/instances", payload)
                        .then(response => {
                            if(response.status==201){
                                this.close();
                                openMessageModal("Assegnazione inoltrata con successo!");
                            }
                        }).catch(error => {
                        showError(error.response.data);
                    });
                    this.close();
                }
            }
        }
    });

    //C-STAMPIGLIA
    Vue.component('StampigliaModal', {
        template: template('stampiglia-modal-template'),
        props: ['show'],
        data: function() {
            var messages = data("messages-model");
            return {
                documento: data("documento-model"),
                listaAllegati: data("allegati-model"),
                messages: messages,
                //TEMPORANEI
                allPages: false,
                aggiungiAnnesso: false,
                tipoStampigliatura: documento.NUM_PG ? "protocollo" : "registrazione",
                posizione: "alto"
            };
        },
        methods: {
            splitText: function(text) {
                return text.split(",");
            },
            close: function() {
                this.$emit('close');
            },
            confermaStampigliatura: function() {
                if(this.tipoStampigliatura=="protocollo"){
                    var openOrStamp = [];
                    for(i=0;i<this.listaAllegati.length;i++) {
                        var docnum = this.listaAllegati[i].DOCNUM;
                        var docname = this.listaAllegati[i].DOCNAME;
                        var url = this.listaAllegati[i].url;
                        if(docname.includes("STAMP_PROT_") && !docname.includes("STAMP_PROT_REG")){
                            openOrStamp.push(docnum, docname, url);
                        }
                    }
                    if (openOrStamp.length>0){
                        this.openPreview(openOrStamp[0], null, openOrStamp[1], openOrStamp[2]);
                        this.$emit('close');
                    } else {
                        this.generaStampigliatura(stampigliaturaProt);
                    }
                }
                if(this.tipoStampigliatura=="registrazione"){
                    var openOrStamp = [];
                    for(i=0;i<this.listaAllegati.length;i++) {
                        var docnum = this.listaAllegati[i].DOCNUM;
                        var docname = this.listaAllegati[i].DOCNAME;
                        var url = this.listaAllegati[i].url;
                        if(docname.includes("STAMP_REG_")){
                            openOrStamp.push(docnum, docname, url);
                        }
                    }
                    if (openOrStamp.length>0){
                        this.openPreview(openOrStamp[0], null, openOrStamp[1], openOrStamp[2]);
                        this.$emit('close');
                    } else {
                        this.generaStampigliatura(stampigliaturaReg);
                    }
                }
                if(this.tipoStampigliatura=="entrambi"){
                    var openOrStamp = [];
                    for(i=0;i<this.listaAllegati.length;i++) {
                        var docnum = this.listaAllegati[i].DOCNUM;
                        var docname = this.listaAllegati[i].DOCNAME;
                        var url = this.listaAllegati[i].url;
                        if(docname.includes("STAMP_PROT_REG_")){
                            openOrStamp.push(docnum, docname, url);
                        }
                    }
                    if (openOrStamp.length>0){
                        this.openPreview(openOrStamp[0], null, openOrStamp[1], openOrStamp[2]);
                        this.$emit('close');
                    } else {
                        this.generaStampigliatura(stampigliaturaProtReg);
                    }
                }
            },
            generaStampigliatura: function(tempStamp) {
                var self = this;
                var testoStampigliatura = tempStamp.replace(/(\{{[^}]+}})/g,function(match, contents, offset, input_string){return self.documento[match.substring(2,match.length-2)];})

                var url_doc = encodeURIComponent(documento.url);
                axios.get("/docer/v1/firma/print?text="+testoStampigliatura+"&style=Serif%2012%20red&posizione="+this.posizione+"&allPages="+this.allPages+"&urls="+url_doc)
                    .then(response => {
                        if(response.status==200){
                            var url = response.data[0];
                            if(this.aggiungiAnnesso==true){

                                listaDocnameAllegati = [];
                                for(i=0;i<this.listaAllegati.length;i++) {
                                    var name = this.listaAllegati[i].DOCNAME;
                                    if(name.includes("STAMP_PROT_") && !name.includes("STAMP_PROT_REG")){
                                        listaDocnameAllegati.push("STAMP_PROT_ESISTENTE");
                                    }
                                    if(name.includes("STAMP_REG_")){
                                        listaDocnameAllegati.push("STAMP_REG_ESISTENTE");
                                    }
                                    if(name.includes("STAMP_PROT_REG_")){
                                        listaDocnameAllegati.push("STAMP_PROT_REG_ESISTENTE");
                                    }
                                }
                                if( (this.tipoStampigliatura=="protocollo") && !(listaDocnameAllegati.toString().includes("STAMP_PROT_ESISTENTE")) ){
                                    nomeStampigliato = "STAMP_PROT_"+this.documento.DOCNAME;
                                } else if( (this.tipoStampigliatura=="registrazione") && !(listaDocnameAllegati.toString().includes("STAMP_REG_ESISTENTE")) ) {
                                    nomeStampigliato = "STAMP_REG_"+this.documento.DOCNAME;
                                } else if( (this.tipoStampigliatura=="entrambi") && !(listaDocnameAllegati.toString().includes("STAMP_PROT_REG_ESISTENTE")) ) {
                                    nomeStampigliato = "STAMP_PROT_REG_"+this.documento.DOCNAME;
                                } else {
                                    nomeStampigliato = "NO";
                                }
                                if(nomeStampigliato!="NO"){
                                    var data = [{
                                        DOCNUM: this.documento.DOCNUM,
                                    },
                                        {
                                            DOCNAME: nomeStampigliato,
                                            TIPO_COMPONENTE: "ANNESSO",
                                            url: url
                                        }]
                                    axios.post("/docer/v1/documenti/multi?relate=true&inline=true", data)
                                        .then(response => {
                                            if(response.status==201){
                                                this.openPreview(null, null, nomeStampigliato, url);
                                                //se ho creato un annesso segno pa pagina come da ricaricare alla chiusura della modale preview
                                                $("#id-reload").val("reload");
                                            }
                                        }).catch(error => {
                                        showError(error.response.data);
                                    });
                                } else {
                                    this.openPreview(null, null, nomeStampigliato, url);
                                }
                            } else {
                                if (this.tipoStampigliatura=="protocollo") {
                                    nomeStampigliato = "STAMP_PROT_"+this.documento.DOCNAME;
                                }
                                if (this.tipoStampigliatura=="registrazione") {
                                    nomeStampigliato = "STAMP_REG_"+this.documento.DOCNAME;
                                }
                                if (this.tipoStampigliatura=="entrambi") {
                                    nomeStampigliato = "STAMP_PROT_REG_"+this.documento.DOCNAME;
                                }
                                this.openPreview(null, null, nomeStampigliato, url);
                            }
                            this.close();
                        }
                    }).catch(error => {
                    showError(error.response.data);
                });
            }
        }
    });

    //C-CRONOLOGIA
    Vue.component('HistoryModal', {
        template: template('history-modal-template'),
        props: ['show','history'],
        data: function() {
            return {
                messages: data("messages-model"),
            };
        },
        methods: {
            accapo: function(text) {
                return text.replaceAll(";",", ");
            },
            close: function() {
                this.$emit('close');
            }
        }
    });

    //C-VERSIONI
    Vue.component('VersionsModal', {
        template: template('versions-modal-template'),
        props: ['show','versions'],
        data: function() {
            return {
                messages: data("messages-model"),
                documento: data("documento-model"),
            };
        },
        methods: {
            getLastChar: function(text){
                var a = text.slice(-1);
                return a;
            },
            close: function() {
                this.$emit('close');
            }
        }
    });

    //C-RIFERIMENTI
    Vue.component('RifModal', {
        //template: template('rif-modal-template'),
        template: '#rif-modal-template', //template interno al viewProfile per include parte dinamica
        props: ['show','riferimenti'],
        data: function () {
            return {
                addRif: '',
                messages: data("messages-model"),
                documento: data("documento-model"),
                model: data("app-data"),//serve per autocompletion
                prerender:true ,//serve per autocompletion
                list : [],//serve per autocompletion
                checkedRifToDelete: []
            };
        },
        replace: false, //serve per autocompletion
        methods: {
            close: function () {
                this.$emit('close');
                this.addRif = ''; //quando esco dal modale cancello il testo inserito nell'input v-model="addRif"
            },
            aggiungiRiferimenti: function(list){
                if(list.length){
                    if (this.documento.riferimenti){
                        var riferimentiDaAggiungere = this.documento.riferimenti;
                        var mergedRif = riferimentiDaAggiungere.concat(list);
                    } else {
                        var mergedRif = list;
                    }
                    var docerClient = new DocerClient();
                    var payload = {
                        riferimenti: mergedRif,
                    }
                    var path = this.documento.DOCNUM;
                    docerClient.documenti.update(path, payload, (data)=>{
                        openMessageModal("Riferimenti aggiornati con successo!");
                    });
                    this.close();
                }
            },
            getMultiDocnumRifToDelete: function () {
                if(this.checkedRifToDelete.length>0){
                    var riferimentiAggiornati = this.documento.riferimenti;
                    var toRemove = this.checkedRifToDelete;
                    var riferimentiAggiornati = riferimentiAggiornati.filter((item) => !toRemove.includes(item));

                    var docerClient = new DocerClient();
                    var payload = {
                        riferimenti: riferimentiAggiornati,
                    }
                    var path = this.documento.DOCNUM;
                    docerClient.documenti.update(path, payload, (data)=>{
                        openMessageModal("Riferimenti aggiornati con successo!");
                    });
                    this.close();
                }
            },
            /*
            getDocnumRifToDelete: function(rifDocnum) {
                if(rifDocnum){
                    //elimino dalla lista dei riferimenti il docnum selezionato
                    var riferimentiAggiornati = this.documento.riferimenti;
                    for( var i = 0; i < riferimentiAggiornati.length; i++){
                        if ( riferimentiAggiornati[i] === rifDocnum) {
                            riferimentiAggiornati.splice(i, 1);
                            i--;
                        }
                    }
                    var docerClient = new DocerClient();
                    var payload = {
                            riferimenti: riferimentiAggiornati,
                        }
                    var path = this.documento.DOCNUM;
                    docerClient.documenti.update(path, payload, (data)=>{
                        openMessageModal("Riferimenti aggiornati con successo!");
                    });
                    this.close();
                }
            },*/
        }
    });

    //C-VERSIONE UD
    Vue.component('VersioneudModal', {
        template: template('versioneud-modal-template'),
        props: ['show','riferimenti'],
        data: function () {
            return {
                addRif: '',
                messages: data("messages-model"),
                documento: data("documento-model"),
                model: data("app-data"),//serve per autocompletion
                prerender:true ,//serve per autocompletion
                list : [],//serve per autocompletion
            };
        },
        replace: false, //serve per autocompletion
        methods: {
            close: function () {
                this.$emit('close');
                this.addRif = ''; //quando esco dal modale cancello il testo inserito nell'input v-model="addRif"
            },
            creaVersioneUd: function(list){
                if(list.length){
                    axios.post("/docer/v1/documenti/"+this.documento.DOCNUM+"/advanced?version="+list[0])
                        .then(response => {
                            if(response.status==200){
                                openMessageModal("Versione UD creata con successo!");
                            }
                        }).catch(error => {
                        showError(error.response.data);
                    });
                    this.close();
                }
            },
        }
    });

    //C-FIRMA
    Vue.component('FirmaModal', {
        template: template('firma-modal-template'),
        props: ['show'],
        data: function () {
            return {
                documento: data("documento-model"),
                messages: data("messages-model"),
                allegati: data("allegati-model"),
                dataVerifica: "",
                checkUd: false,
            };
        },
        methods: {
            close: function () {
                this.$emit('close');
            },
            confermaVerificaFirma: function() {
                $(".modalSignContent").empty();
                this.$emit('close');
                var data = "";
                if(this.dataVerifica){
                    data = "&verificationDate="+this.dataVerifica;
                }
                var urlAllegati = [];
                if(this.checkUd==true){
                    for( var i = 0; i < this.allegati.length; i++){
                        if(this.allegati[i].TIPO_COMPONENTE!='ANNESSO'){
                            urlAllegati.push(this.allegati[i].url);
                        }
                    }
                }else{
                    urlAllegati.push(this.allegati[0].url);
                }
                var urls = urlAllegati.toString().replaceAll(",","&urls=");
                axios.get("/docer/v1/firma/report?urls="+urls+data)
                    .then(response => {
                        $("#modalSign").show();
                        $(".modalSignContent").append(response.data);
                    })
                    .catch(error => {
                        if (error.response.data.code=="E000"){
                            alert("Documento non firmato");
                        } else {
                            showError(error.response.data);
                        }
                    });
            }
        }
    });

    //C-FIRMA REMOTA
    Vue.component('FirmaremotaModal', {
        template: template('firmaremota-modal-template'),
        props: ['show'],
        data: function () {
            allegati = JSON.parse($("#allegati-model").text());
            return {
                documento: data("documento-model"),
                messages: data("messages-model"),
                listaAllegati: allegati,
                checkedFiles:[data("documento-model").DOCNAME+"#"+data("documento-model").url],//imposto il documento corrente
                tipiFirma: [
                    { text: 'PAdES', value: 'pades' },
                    { text: 'CAdES', value: 'cades' },
                    { text: 'XAdES', value: 'xades' }
                ],
                selected: "pades",
                alias: "", //certificate
                pin: "", //password
                otp: "",
                disabled: true,
                disabledBtn: true,
                disabledCheck: true,
                filesForUd: [],
                docnumUrl: [],
                showPassword: false,
                addAvancedVersion: false,
                urls: [],
                files: [],
            };
        },
        created() {
            //axios.get("/docer/v1/documenti/tipologie?tipo=ALLEGATO")
            axios.get("/docer/v1/documenti/tipologie?tipo=*") //query temporanea
                .then(response => {
                    this.tipologieAllegato = response.data;
                })
                .catch(error => {
                    showError(error.response.data);
                });
        },
        methods: {
            close: function () {
                this.$emit('close');
            },
            richiediOtp: function () {
                $("#errMsg-firmaremota").hide().text("");
                if (!this.alias||!this.pin) {
                    $("#errMsg-firmaremota").show().append('<p class="info-error">campi <b>*</b> obbligatori!</p>');
                } else {
                    axios.get("/docer/v1/firma/requestOTP?alias="+this.alias+"&pin="+this.pin)
                        .then(response => {
                            if(response.status==200){
                                //abilito input otp
                                this.disabled = !this.disabled;
                            }
                        })
                        .catch(error => {
                            showError(error.response.data);
                        });
                }
            },
            confermaFirmaDocumento: function() {
                $("#errMsg-firmaremota").hide().text("");
                if (!this.alias||!this.pin||this.checkedFiles.length==0) {
                    $("#errMsg-firmaremota").show().append('<p class="info-error">campi <b>*</b> obbligatori!</p>');
                } else {
                    for(i=0;i<this.checkedFiles.length;i++) {
                        var docnum = this.checkedFiles[i].split('documenti/').pop().split('/file')[0];
                        var docname = this.checkedFiles[i].split('.')[0];
                        var url = this.checkedFiles[i].split('#')[1];
                        this.urls.push(url);
                        this.docnumUrl.push(docnum+"#"+docname);
                        $(".scaricaFirmati").hide();
                    }
                    if (this.otp) {
                        var query = "/docer/v1/firma/firmaRemota?opt="+this.otp+"&alias="+this.alias+"&pin="+this.pin+"&tipo="+this.selected+"&urls="+this.urls;
                    } else {
                        var query = "/docer/v1/firma/firmaRemota?alias="+this.alias+"&pin="+this.pin+"&tipo="+this.selected+"&urls="+this.urls;
                    }
                    axios.post(query)
                        .then(response => {
                            if(response.status==200){
                                var a = [];
                                a = this.docnumUrl;
                                var b = [];
                                b = response.data;
                                //unisco i valori dei 2 array per posizione
                                function merge(a, b) {
                                    if (a.length == b.length) {
                                        var c = [];
                                        for (var i = 0; i < a.length; i++) {
                                            c.push([a[i], b[i]]);
                                        }
                                        return c;
                                    }
                                    return null;
                                }
                                var c = merge(a, b);
                                //dall'array mergiato unisco le prime 2 posizioni divise da #
                                var docnumAndUrl = [];
                                for (var w = 0; w < c.length; w++) {
                                    d = c[w].toString();
                                    e = d.replace(",","#");
                                    docnumAndUrl.push(e);
                                }

                                this.filesForUd = [];
                                //costruisco il tasto scarica firmato con il docnum (id) e url per download
                                for(j=0;j<docnumAndUrl.length;j++) {
                                    var num = docnumAndUrl[j].split('#')[0];
                                    var name = docnumAndUrl[j].split('#')[1];
                                    var url = docnumAndUrl[j].split('files')[1];
                                    $("#btn"+num).show().attr("href", "/docer/v1/files"+url);

                                    this.filesForUd.push("/docer/v1/files"+url+"#"+name);
                                }
                                this.docnumUrl = [];
                                this.urls=[];
                                //abilito tasto creaUD
                                if(this.filesForUd.length>0){
                                    this.disabledBtn = false;
                                    this.disabledCheck = false;
                                }
                            }
                        })
                        .catch(error => {
                            this.docnumUrl = [];
                            this.urls=[];
                            showError(error.response.data);
                        });
                }
            },
            caricaFilePerFirma: function(files){
                console.log(files);
                if(files.length>0){
                    for(i=0;i<files.length;i++) {
                        var data = [];
                        data.push({
                            "DOCNAME" : files[i].name,
                            "url" : files[i].url,
                            "TYPE_ID" : "Documento",
                            "TIPO_COMPONENTE" : "ALLEGATO"
                        });

                        axios.post("/docer/v1/documenti/multi",data )
                            .then(response => {
                                if(response.status==201){
                                    this.listaAllegati.push(response.data[0]);
                                    //imposto i file caricati con il checked attivo
                                    this.checkedFiles.push(response.data[0].DOCNAME+"#"+response.data[0].url);
                                }
                            }).catch(error => {
                            showError(error.response.data);
                        });
                    }
                    //elimino tutti i file caricati dalla lista
                    $('.removeFileCaricati').trigger("click");
                }
            },
            creaUdFirmati: function() {
                console.log(this.filesForUd);

                var data = [];
                for(idx in this.filesForUd) {
                    var estensione = this.filesForUd[idx].split('.').pop().split('#')[0];
                    var nome = this.filesForUd[idx].split('#')[1];
                    var urlNewFile = this.filesForUd[idx].split('#')[0];
                    if (idx == 0) {
                        var tipoComponente = "PRINCIPALE";
                    } else {
                        var tipoComponente = "ALLEGATO";
                    }
                    data.push({
                        "DOCNAME" : nome+"_signed."+estensione,
                        "url" : urlNewFile,
                        "TYPE_ID" : "Documento",
                        "TIPO_COMPONENTE" : tipoComponente
                    });
                }

                axios.post("/docer/v1/documenti/multi?relate=true",data )
                    .then(response => {
                        if(response.status==201){
                            var docnum = response.data[0].DOCNUM;
                            if(this.addAvancedVersion==true){
                                axios.post("/docer/v1/documenti/"+this.documento.DOCNUM+"/advanced?version="+docnum)
                                    .then(response => {
                                        if(response.status==200){
                                            this.$emit('close');
                                            $("#docNewUd").val(docnum);
                                            $("#messageGoToModal").modal();
                                        }
                                    }).catch(error => {
                                    showError(error.response.data);
                                });
                            }else{
                                this.$emit('close');
                                $("#docNewUd").val(docnum);
                                $("#messageGoToModal").modal();
                            }
                        }
                    }).catch(error => {
                    showError(error.response.data);
                });
            },
            disableBtn: function() {
                this.disabledBtn = true;
                this.disabledCheck = true;
                $(".scaricaFirmati").hide();
            }
        }
    });

    //C-NOTIFICHE
    Vue.component('NotificheModal', {
        template: template('notifiche-modal-template'),
        props: ['show','notifiche'],
        data: function () {
            return {
                documento: data("documento-model"),
                messages: data("messages-model"),
                dettaglioNotifica: [],
            };
        },
        methods: {
            close: function () {
                this.$emit('close');
            },
            openNotificaDetail: function (id) {
                axios.get("/bpm/v1/notifications/"+id+"?fetch=*") //recupero dettaglio notifiche
                    .then(response => {
                        if(response.data){
                            this.dettaglioNotifica = response.data;
                        }
                    })
                    .catch(error => {
                        showError(error.response.data);
                    });
                $('#notifiche').hide();
                $('#dettaglioNotifica, #apriNotifiche').show();
            },
            chiudiDettaglioNotifica: function () {
                $('#dettaglioNotifica, #apriNotifiche').hide();
                $('#notifiche').show();
            },
            chiudiNotifiche: function () {
                $('#dettaglioNotifica, #apriNotifiche').hide();
                $('#notifiche').show();
                if(this.notificheAggiornate!=undefined){
                    openMessageModal("Notifiche segnate come lette!");
                }
                this.$emit('close');
            },
            markAsRead: function(id) {
                axios.put("/bpm/v1/notifications/"+id+"/read")
                    .then(response => {
                        if(response.status==200){
                            axios.get("/bpm/v1/notifications?fetch=*&tags=DOCNUM:"+documento.DOCNUM) //recupero notifiche
                                .then(response => {
                                    if(response.data.data){
                                        this.notifiche = response.data.data;
                                        this.notificheAggiornate = this.notifiche; //var per gestione reload pagina se notifiche lette
                                    }
                                })
                                .catch(error => {
                                    showError(error.response.data);
                                });
                        }
                    }).catch(error => {
                    showError(error.response.data);
                });
            },
        }
    });

    //C-REGISTRA
    Vue.component('RegModal', {
        template: template('reg-modal-template'),
        props: ['show','tipireg'],
        data: function () {
            return {
                documento: data("documento-model"),
                messages: data("messages-model"),
            };
        },
        methods: {
            close: function () {
                this.$emit('close');
            },
            confermaRegistraDocumento: function () {
                $("#errMsg-registra").hide().text("");
                if( !this.documento.ID_REGISTRO || !this.documento.O_REGISTRAZ ) {
                    $("#errMsg-registra").show().append('<p class="info-error">campi <b>*</b> obbligatori!</p>');
                } else {
                    axios.post("/docer/v1/documenti/"+this.documento.DOCNUM+"/registra?oggetto="+this.documento.O_REGISTRAZ+"&registro="+this.documento.ID_REGISTRO)
                        .then(response => {
                            if(response.status==200){
                                openMessageModal("Documento registrato con successo!");
                                this.close();
                            }
                        }).catch(error => {
                        showError(error.response.data);
                    });
                }
            }
        }
    });

    //C-ANNULLA REGISTRAZIONE
    Vue.component('AnnullaregModal', {
        template: template('annullareg-modal-template'),
        props: ['show'],
        data: function () {
            return {
                documento: data("documento-model"),
                messages: data("messages-model"),
            };
        },
        methods: {
            close: function () {
                this.$emit('close');
            },
            confermaAnnullaRegistrazione: function () {
                $("#errMsg-annullaRegistrazione").hide().text("");
                if( !this.documento.M_ANNULL_REGISTRAZ || !this.documento.P_ANNULL_REGISTRAZ ) {
                    $("#errMsg-annullaRegistrazione").show().append('<p class="info-error">campi <b>*</b> obbligatori!</p>');
                } else {
                    axios.post("/docer/v1/documenti/"+this.documento.DOCNUM+"/annullaRegistrazione?motivazione="+this.documento.M_ANNULL_REGISTRAZ+"&riferimento="+this.documento.P_ANNULL_REGISTRAZ)
                        .then(response => {
                            if(response.status==200){
                                openMessageModal("Registrazione annullata con successo!");
                                this.close();
                            }
                        }).catch(error => {
                        showError(error.response.data);
                    });
                }
            }
        }
    });

    //C-ANNULLA PROTOCOLLAZIONE
    Vue.component('AnnullaprotoModal', {
        template: template('annullaproto-modal-template'),
        props: ['show'],
        data: function () {
            return {
                documento: data("documento-model"),
                messages: data("messages-model"),
            };
        },
        methods: {
            close: function () {
                this.$emit('close');
            },
            confermaAnnullaProtocollo: function () {
                axios.post("/docer/v1/documenti/"+this.documento.DOCNUM+"/annullaProtocollazione?motivazione="+this.documento.M_ANNULL_PG+"&riferimento="+this.documento.P_ANNULL_PG)
                    .then(response => {
                        if(response.status==200){
                            openMessageModal("Avviato procedimento di annulamento protocollo!");
                            this.close();
                        }
                    }).catch(error => {
                    showError(error.response.data);
                });
            }
        }
    });

    //C-MODIFICA DOCUMENTO
    Vue.component('EditprofileModal', {
        template: '#editprofile-modal-template', //template interno al viewProfile per include parte dinamica
        props: ['show','tipidoc'],
        data: function () {
            return {
                documento: data("documento-model"),
                messages: data("messages-model"),
            };
        },
        methods: {
            close: function () {
                this.$emit('close');
            },
            confermaModificaDocumento: function () {
                $("#errMsg-editProfile").hide().text("");
                if( $("#nameDoc").val() == "") {
                    $("#errMsg-editProfile").show().append('<p class="info-error">campi <b>*</b> obbligatori!</p>');
                } else {
                    var docerClient = new DocerClient();
                    var payload = {
                        //parte comune
                        DOCNAME: this.documento.DOCNAME,
                        DATA_DOCUMENTO: this.documento.DATA_DOCUMENTO,
                        ABSTRACT: this.documento.ABSTRACT,
                    }
                    //parte dinamica in base alla tipologia
                    $('.editContainer .nameToBuildPayload').each(function() {
                        payload[$(this).attr('name')]= $(this).val(); //mappa
                    });

                    var path = this.documento.DOCNUM;
                    docerClient.documenti.update(path, payload, (data)=>{
                        goToDocument("Documento aggiornato con successo!",this.documento.DOCNUM)
                    });
                    this.close();
                }
            }
        }
    });

    //C-MODIFICA TIPOLOGIA
    Vue.component('EdittypeModal', {
        template: template('edittype-modal-template'),
        props: ['show','tipidoc'],
        data: function () {
            return {
                documento: data("documento-model"),
                messages: data("messages-model"),
            };
        },
        methods: {
            close: function () {
                this.$emit('close');
            },
            confermaCambiaTipologia: function () {
                var docerClient = new DocerClient();
                var payload = {
                    TYPE_ID: this.documento.TYPE_ID,
                }
                var path = this.documento.DOCNUM;
                docerClient.documenti.update(path, payload, (data)=>{
                    openMessageModal("Tipologia documento modificata con successo!");
                });
                this.close();
            }
        }
    });

    //C-CLASSIFICA
    Vue.component('ClassificaModal', {
        template: template('classifica-modal-template'),
        props: ['show'],
        data: function () {
            return {
                documento: data("documento-model"),
                messages: data("messages-model"),
                model: data("app-data"),//serve per autocompletion
                prerender:true ,//serve per autocompletion
            };
        },
        replace: false, //serve per autocompletion
        methods: {
            close: function () {
                this.$emit('close');
            },
            confermaClassifica: function() {
                $("#errMsg-classifica").hide().text("");
                if(this.$classificaP.length>0 && this.$classificaP[0].id){
                    var formData = new FormData();
                    formData.append('docnum', this.documento.DOCNUM);
                    formData.append('classifica', this.$classificaP[0].id.toString());
                    if(this.$classificheS.length>0 && this.$classificheS[0].id){
                        for(i=0;i<this.$classificheS.length;i++) {
                            formData.append('secondarie', this.$classificheS[i].id);
                        }
                    } else {
                        formData.append('secondarie', "");
                    }

                    axios.post("/docer/v1/documenti/"+this.documento.DOCNUM+"/classifica", formData)
                        .then(response => {
                            if(response.status==200){
                                //this.documento = response.data;
                                this.close();
                                openMessageModal("Documento classificato con successo!");
                            }
                        }).catch(error => {
                        showError(error.response.data);
                    });
                    this.close();
                } else {
                    $("#errMsg-classifica").show().append('<p class="info-error">classifiche mancanti!</p>');
                }

            }
        }
    });

    //C-FASCICOLO
    var FascicolaModal = Vue.component('FascicolaModal', {
        template: template('fascicola-modal-template'),
        props: ['show'],
        data: function () {
            return {
                flag: true,
                documento: data("documento-model"),
                messages: data("messages-model"),
                model: data("app-data"),//serve per autocompletion
                prerender:true ,//serve per autocompletion
            };
        },
        replace: false, //serve per autocompletion
        methods: {
            close: function () {
                this.$emit('close');
            },
            addFasc: function () {
                this.$fascicoliDocumento.push({ });
                this.$forceUpdate();
            },
            deleteFasc: function (index) {
                this.$fascicoliDocumento.splice(index, 1);
                this.$forceUpdate();
                if ($('.deleteListFascicolo').length == 1) { //se elimino l'ultimo elemento nascondo la label Primario
                    $('.f-primario').hide();
                }
            },
            confermaFascicolaDocumento: function() {
                $("#errMsg-fascicola").hide().text("");
                //controllo se ci sono campi autocompletion lasciati vuoti
                for (i = 0; i < this.$fascicoliDocumento.length; i++) {
                    console.log(this.$fascicoliDocumento[i]);
                    if (this.$fascicoliDocumento[i] == undefined) {
                        $("#errMsg-fascicola").show().append('<p class="info-error">fascicoli mancanti!</p>');
                        return false;
                    } else {
                        if (this.$fascicoliDocumento[i].id == undefined) {
                            $("#errMsg-fascicola").show().append('<p class="info-error">fascicoli mancanti!</p>');
                            return false;
                        }
                    }
                }
                if(this.$fascicoliDocumento.length){
                    var formData = new FormData();
                    formData.append('docnum', this.documento.DOCNUM);
                    if (this.$fascicoliDocumento.length>1){
                        fascicoloPrimario = this.$fascicoliDocumento.slice(0, 1);
                        fascicoliSecondari = this.$fascicoliDocumento.slice(1);
                        formData.append('primario', fascicoloPrimario[0].id.toString().replaceAll("|", "/"));
                        for(i=0;i<fascicoliSecondari.length;i++) {
                            formData.append('secondari', fascicoliSecondari[i].id.replaceAll("|", "/"));
                        }
                    } else {
                        formData.append('primario', this.$fascicoliDocumento[0].id.toString().replaceAll("|", "/"));
                        formData.append('secondari', "");
                    }
                    axios.post("/docer/v1/documenti/"+this.documento.DOCNUM+"/fascicola", formData)
                        .then(response => {
                            if(response.status==200){
                                //this.documento = response.data;
                                this.close();
                                openMessageModal("Documento fascicolato con successo!");
                            }
                        }).catch(error => {
                        showError(error.response.data);
                    });
                    this.close();
                } else {
                    $("#errMsg-fascicola").show().append('<p class="info-error">selezionare almeno un fascicolo!</p>');
                }
            },
            openNewFascicolo: function () {
                this.close();
                $('#btn-nuovofascicolo').trigger("click");
            },
            closeAndOperClassifica: function () {
                this.close();
                $('#btn-classifica').trigger("click");
            }
        }
    });

    //C-NUOVO FASCICOLO
    var NuovofascicoloModal = Vue.component('NuovofascicoloModal', {
        template: template('nuovofascicolo-modal-template'),
        props: ['show'],
        data: function () {
            return {
                messages: data("messages-model"),
                label: "",
                classifica: [{}],
                fascPadre: [{}],
                descFasc: "",
                url: "/docer/v1/solr/select?database=false&sort=sid asc&fq=type:fascicolo&fq=CLASSIFICA:*&wt=json&fl=sid,text:name&q=name:%24%7Bterm%7D OR FASCICOLO_ID:*/%24%7Bterm%7D&term=..."
            };
        },
        watch: {
            classifica: function(newVal, oldVal) { // watch it
                if (this.classifica.length>0){
                    var c = this.classifica[0].id;
                } else {
                    var c = "*";
                    classifica=[{}];
                    fascPadre=[{}];
                    $("#padre").empty();
                }
                this.url =  "/docer/v1/solr/select?database=false&sort=sid asc&fq=type:fascicolo&fq=CLASSIFICA:"+c+"&wt=json&fl=sid,text:name&q=name:%24%7Bterm%7D OR FASCICOLO_ID:*/%24%7Bterm%7D&term=...";
                //this.$refs['select2-padre'].url = this.url;
                //this.$refs['select2-padre'].$mount();
            }
        },
        methods: {
            close: function () {
                this.$emit('close');
            },
            confermaNuovoFascicolo: function() {
                $("#errMsg-nuovoFascicolo").hide().text("");
                if(this.descFasc.length == 0){
                    $("#errMsg-nuovoFascicolo").show().append('<p class="info-error">Descrizione obbligatoria!</p>');
                } else {
                    if(this.classifica[0].id){
                        var classificaRecuperata = this.classifica[0].id.toString();
                    }
                    if(this.fascPadre[0].id!=undefined){
                        var classificaAnnoParent = this.fascPadre[0].id.toString();
                        var parent = /[^|]*$/.exec(classificaAnnoParent)[0];
                        var classificaRecuperata = classificaAnnoParent.split("|")[0];
                    }
                    if(!this.classifica[0].id && this.fascPadre[0].id==undefined){
                        $("#errMsg-nuovoFascicolo").show().append('<p class="info-error">Classifica obbligatoria!</p>');
                        return false;
                    }
                    var payload = {
                        CLASSIFICA: classificaRecuperata,
                        PARENT_PROGR_FASCICOLO: parent,
                        DES_FASCICOLO: this.descFasc,
                    }
                    axios.post("/docer/v1/fascicoli", payload)
                        .then(response => {
                            if(response.status==201){
                                this.close();
                                openMessageModal("Fascicolo creato con successo!");
                            }
                        }).catch(error => {
                        showError(error.response.data);
                    });
                    this.close();
                }
            },
        }
    });

    //abilito tooltip
    $(function() {
        $('[data-toggle="tooltip"]').tooltip()
    });

    //profileDocument
    var app = new Vue({
        el: '#profileDocument',
        data: function() {
            //var model = JSON.parse($("#documento-model").text()); - problema JSON.parse con caratteri "<>" risolto con routine dentro commons.js data("xxx")
            return {
                messages: data("messages-model"),
                showShareModal: false,
                showTaskModal: false,
                showHistoryModal: false,
                showVersionsModal: false,
                riferimentiDocumento:[],
                versioniudDocumento:[],
                historyDocumento:[],
                versionsDocumento:[],
                tipologieDocumento:[],
                tipologieRegistri:[],
                showRifModal: false,
                showRegModal: false,
                showFirmaModal: false,
                showFirmaremotaModal: false,
                showFascicolaModal: false,
                showNuovofascicoloModal: false,
                showClassificaModal: false,
                showEditprofileModal: false,
                showVersioneudModal: false,
                showAssignModal: false,
                showStampigliaModal: false,
                showNotificheModal: false,
                documento: data("documento-model"),
                listaAllegati: data("allegati-model"),
                task: data("task-model"),
                showAnnullaregModal: false,
                showAnnullaprotoModal: false,
                showEditTypeModal: false,
                model: data("app-data"),//serve per autocompletion
                prerender:true ,//serve per autocompletion
                list : [],//serve per autocompletion
                single : "",
                label: "",
                notifiche: [],
                notificheAggiornate: [],
                numNotifiche: "",
                files: [],
            }

        },
        replace: false, //serve per autocompletion
        /*beforeCreate: function() {
            console.log(this.$appName)
        },*/
        created() {
            documento = data("documento-model");
            if(documento.CLASSIFICA){ // se il documento  classificato
                if(documento.CLASS_SECONDARIE_MV){
                    //idClassificheForQuery = documento.CLASSIFICA + " " + documento.CLASS_SECONDARIE_MV.replaceAll(","," ");
                    idClassificheForQuery = documento.CLASSIFICA + " " + documento.CLASS_SECONDARIE_MV.toString().replaceAll(","," ");
                } else {
                    idClassificheForQuery = documento.CLASSIFICA;
                }
                axios.get("/docer/v1/solr/select?database=false&fq=type:titolario&wt=json&fl=CLASSIFICA,text:name&q=CLASSIFICA:("+idClassificheForQuery+")")
                    .then(response => {
                        if(response.data.data){
                            var theArray = response.data.data;
                            this.$classificaP.shift();
                            this.$classificheS.shift();
                            //rimuovo il primo elemento che  vuoto, perch se uso classificheS : [] quando svuoto l'autocompletion e metto 1 elemento lo mette come array senza id e text
                            for (var i = 0; i < theArray.length; i++) {
                                if (theArray[i].CLASSIFICA==documento.CLASSIFICA){ //recupero la classifica principale
                                    this.$classificaP.push({ id: theArray[i].CLASSIFICA, text: theArray[i].text });
                                }else {

                                    this.$classificheS.push({ id: theArray[i].CLASSIFICA, text: theArray[i].text });
                                }
                            }
                            Vue.prototype.$classificaP = this.$classificaP;
                            Vue.prototype.$classificheS = this.$classificheS;
                            this.$forceUpdate(); //forzo update var per visualizzare info recuperate
                        }
                    })
                    .catch(error => {
                        showError(error.response.data);
                    });
            }

            if(documento.ANNO_FASCICOLO && documento.CLASSIFICA){ // se il documento  fascicolato
                fascicoloPrimario = documento.CLASSIFICA+"/"+documento.ANNO_FASCICOLO+"/"+documento.PROGR_FASCICOLO;
                if(documento.FASC_SECONDARI){
                    fascicoliSecondari = documento.FASC_SECONDARI;
                    idFascicoliForQuery = fascicoliSecondari.replaceAll(";"," ") +fascicoloPrimario;
                } else {
                    idFascicoliForQuery = fascicoloPrimario;
                }
                axios.get("/docer/v1/solr/select?database=false&fq=type:fascicolo&wt=json&fl=FASCICOLO_ID,text:name&q=FASCICOLO_ID:("+idFascicoliForQuery+")")
                    .then(response => {
                        if(response.data.data){
                            var theArray = response.data.data;
                            for (var i = 0; i < theArray.length; i++) {
                                if (theArray[i].FASCICOLO_ID==fascicoloPrimario){ //recupero il fascicolo principale
                                    this.$fascicoloP.push({ id: theArray[i].FASCICOLO_ID, text: theArray[i].text });
                                }else {
                                    this.$fascicoliS.push({ id: theArray[i].FASCICOLO_ID, text: theArray[i].text});
                                }
                            }
                            Vue.prototype.$fascicoloP = this.$fascicoloP;
                            Vue.prototype.$fascicoliS = this.$fascicoliS;
                            //unisco fascicolo principale con i secondari
                            Vue.prototype.$fascicoliDocumento = this.$fascicoloP.concat(this.$fascicoliS);
                            this.$forceUpdate(); //forzo update var per visualizzare info recuperate
                            //recupero classifiche derivate (classifiche dei fascicoli secondari)
                            var classificheFascicoliS = [];
                            for (var w = 0; w < this.$fascicoliS.length; w++) {
                                classificheFascicoliS.push(this.$fascicoliS[w].id.split('/')[0]);
                                //elimino eventuali duplicati
                                var uniqueClassificheFascicoliS = classificheFascicoliS.filter(function(elem, index, self) {
                                    return index === self.indexOf(elem);
                                });
                                var idClassificheDerivateForQuery = uniqueClassificheFascicoliS.toString().replaceAll(","," ");
                            }
                            if(idClassificheDerivateForQuery){ // se ci sono classifiche derivate
                                axios.get("/docer/v1/solr/select?database=false&fq=type:titolario&wt=json&fl=CLASSIFICA,text:name&q=CLASSIFICA:("+idClassificheDerivateForQuery+")")
                                    .then(response => {
                                        if(response.data.data){
                                            var theArray = response.data.data;
                                            for (var i = 0; i < theArray.length; i++) {
                                                //se classifica gia presente nel fascicolo principale la scarto
                                                if (theArray[i].CLASSIFICA!=documento.CLASSIFICA) {
                                                    this.$classificheDerivate.push({ id: theArray[i].CLASSIFICA, text: theArray[i].text});
                                                }
                                            }
                                            Vue.prototype.$classificheDerivate = this.$classificheDerivate;
                                            this.$forceUpdate(); //forzo update var per visualizzare info recuperate
                                        }
                                    })
                                    .catch(error => {
                                        showError(error.response.data);
                                    });
                            }
                        }
                    })
                    .catch(error => {
                        showError(error.response.data);
                    });
            }
            //axios.get("/bpm/v1/tasks?attachments="+documento.DOCNUM) //recupero tutti i task
            axios.get("/bpm/v1/tasks?assignedAs=PotentialOwner&attachments="+documento.DOCNUM+"&activeOnly=true") //recupero task MIEI e ATTIVI
                .then(response => {
                    if(response.data.data){
                        this.task = response.data.data;
                    }
                })
                .catch(error => {
                    showError(error.response.data);
                });
            axios.get("/bpm/v1/notifications?fetch=*&tags=DOCNUM:"+documento.DOCNUM) //recupero notifiche
                .then(response => {
                    if(response.data.data){
                        this.notifiche = response.data.data;
                    }
                })
                .catch(error => {
                    showError(error.response.data);
                });
        },
        updated() {
            this.numNotifiche = $('.numNotifiche').length;
        },
        methods: {
            getDocnumRiferimenti: function(text) {
                if(text){
                    var docnumRif = [];
                    for(i=0;i<text.length;i++) {
                        var a = text[i].split(/[\s@]+/)[0];
                        var b = a.split(/[\s!]+/).pop();
                        docnumRif.push(b);
                        var c = docnumRif.toString();
                        d = c.replaceAll(","," ");
                    }
                    return d;
                }
            },
            calcolaNumRif: function(text) {
                var numRif = text.length;
                return numRif;
            },
            showTask: function() {
                var radios = document.getElementsByName('allTask');
                for (var i = 0, length = radios.length; i < length; i++) {
                    if (radios[i].checked) {
                        var visibleTask = radios[i].value;

                        if(visibleTask=="all"){
                            if ($("#myTask").is(":checked")){
                                var query = "/bpm/v1/tasks?assignedAs=PotentialOwner&attachments="+this.documento.DOCNUM+"&activeOnly=false";
                            }else{
                                var query = "/bpm/v1/tasks?attachments="+this.documento.DOCNUM+"&activeOnly=false";
                            }
                            axios.get(query)
                                .then(response => {
                                    if(response.data.data){
                                        this.task = response.data.data;
                                    }
                                })
                                .catch(error => {
                                    showError(error.response.data);
                                });
                        }
                        if(visibleTask=="open"){
                            if ($("#myTask").is(":checked")){
                                var query = "/bpm/v1/tasks?assignedAs=PotentialOwner&attachments="+this.documento.DOCNUM+"&activeOnly=true";
                            }else{
                                var query = "/bpm/v1/tasks?attachments="+this.documento.DOCNUM+"&activeOnly=true";
                            }
                            axios.get(query)
                                .then(response => {
                                    if(response.data.data){
                                        this.task = response.data.data;
                                    }
                                })
                                .catch(error => {
                                    showError(error.response.data);
                                });
                        }
                        if(visibleTask=="completed"){
                            if ($("#myTask").is(":checked")){
                                var query = "/bpm/v1/tasks?assignedAs=PotentialOwner&attachments="+this.documento.DOCNUM+"&activeOnly=false&status=Completed";
                            }else{
                                var query = "/bpm/v1/tasks?attachments="+this.documento.DOCNUM+"&activeOnly=false&status=Completed";
                            }
                            axios.get(query)
                                .then(response => {
                                    if(response.data.data){
                                        this.task = response.data.data;
                                    }
                                })
                                .catch(error => {
                                    showError(error.response.data);
                                });
                        }
                        break;
                    }
                }
            },
            openRifModalWithDocnum: function(docnum) {
                if($("#riferimenti-model").text()){ //test locale
                    axios.get("./static/templates/json-template/documento.json")
                        .then(response => {
                            this.riferimentiDocumento = response.data.data;
                            this.showRifModal = true
                        })
                        .catch(error => {
                            this.riferimentiDocumento = data("riferimenti-model");
                            this.showRifModal = true
                        });
                }else{
                    axios.get("/docer/v1/documenti?q=DOCNUM:("+docnum+")")
                        .then(response => {
                            this.riferimentiDocumento = response.data.data;
                            this.showRifModal = true
                        })
                        .catch(error => {
                            showError(error.response.data);
                        });
                }
            },
            openVersionsUDModalWithDocnum: function() {
                axios.get("/docer/v1/documenti/"+this.documento.DOCNUM+"/advanced")
                    .then(response => {
                        //ordino risultati per versione
                        const datiOrdinati = response.data.sort((a, b) => b.DOC_VERSION - a.DOC_VERSION);
                        this.versioniudDocumento = datiOrdinati;
                        this.showVersioneudModal = true
                    })
                    .catch(error => {
                        showError(error.response.data);
                    });
            },
            searchDocType: function() {
                axios.get("/docer/v1/documenti/tipologie")
                    .then(response => {
                        this.tipologieDocumento = response.data;
                        this.showEditTypeModal = true
                    })
                    .catch(error => {
                        showError(error.response.data);
                    });
            },
            searchRegistri: function() {
                axios.get("/docer/v1/documenti/registri")
                    .then(response => {
                        this.tipologieRegistri = response.data;
                        this.showRegModal = true
                    })
                    .catch(error => {
                        showError(error.response.data);
                    });
            },
            lockDoc: function() { //blocca documento
                axios.post("/docer/v1/documenti/"+this.documento.DOCNUM+"/lock")
                    .then(response => {
                        if(response.status==200){
                            this.documento.lockedBy = response.data.lockedBy;
                            $("#btnLock").html("<i class='bi bi-unlock mainColorDark'></i>");
                        }
                    })
            },
            unlockDoc: function() { //sblocca documento
                axios.post("/docer/v1/documenti/"+this.documento.DOCNUM+"/unlock")
                    .then(response => {
                        if(response.status==200){
                            this.documento.lockedBy = response.data.lockedBy;
                            $("#btnUnlock").html("<i class='bi bi-lock mainColorDark'></i>");
                        }
                    })
            },
            rendiPrincipale: function(docnum) {
                var docerClient = new DocerClient();
                var payload = {
                    TIPO_COMPONENTE: "PRINCIPALE",
                }
                var path = docnum;
                docerClient.documenti.update(path, payload, (data)=>{
                    openMessageModal("Modifica avvenuta con successo!");
                });
            },
            vaiAlPrincipale: function(docnum) {
                window.location.href = "/~documentoDOCNUM="+docnum;
            },
            creaCopiaAnalogica: function() {
                axios.get("/bl/v1/creaCopiaAnalogica?docNum="+this.documento.DOCNUM)
                    .then(response => {
                        goToDocument("Copia analogica creata con successo!",response.data.docnum);
                        //window.location.href = "/documenti/viewProfile?DOCNUM="+response.data.docnum;
                    })
                    .catch(error => {
                        showError(error.response.data);
                    });
            },
            /*scaricaCopiaAnalogica: function() {
                axios.get("/bl/v1/creaCopiaAnalogica?docNum="+this.documento.DOCNUM)
                .then(response => {
                    window.location.href = "/docer/v1/documenti/"+response.data.docnum+"/file";
                    window.location.reload();
                })
                .catch(error => {
                    showError(error.response.data);
                });
            },*/
            downloadPdf: function() {
                axios.post("/bl/v1/convert?docnum="+this.documento.DOCNUM)
                    .then(response => {
                        var uri = response.data.file.uri;
                        var url = uri.split('files')[1];
                        //fileName sovrascrivo il file name temporaneo con il nome del file
                        window.location.href = "/docer/v1/files"+url+"?fileName="+response.data.file.name;
                    })
                    .catch(error => {
                        showError(error.response.data);
                    });
            },
            confirmDelete: function () {
                $("#messageDeleteModal").modal('show');
                $('#messageDeleteModalTxtTitle').text("sicuro di voler eliminare il documento: ");
                $('#messageDeleteModalTxt').text(this.documento.DOCNAME +" (" + this.documento.DOCNUM + ")");
            },
            deleteDoc: function() {
                axios.delete("/docer/v1/documenti/"+this.documento.DOCNUM)
                    .then(response => {
                        if(response.status==204){
                            $("#messageDeleteModal").modal('hide');
                            var msg="deleted"
                            window.location.href = "/documenti/messagePage?"+msg;
                        }
                    })
                    .catch(error => {
                        showError(error.response.data);
                    });
            },
            historyDoc: function() {
                axios.get("/docer/v1/documenti/" + this.documento.DOCNUM + "/history")
                    .then(response => {
                        this.historyDocumento = response.data;
                        this.showHistoryModal = true
                    })
                    .catch(error => {
                        showError(error.response.data);
                    });
            },
            versionsDoc: function() {
                axios.get("/docer/v1/documenti/" + this.documento.DOCNUM + "/versions")
                    .then(response => {
                        this.versionsDocumento = response.data;
                        this.showVersionsModal = true
                    })
                    .catch(error => {
                        showError(error.response.data);
                    });
            },
            protocollaDoc: function() {
                //var classifica_desc = Vue.prototype.$classificaP[0].text;
                //window.location.href = "protocollo?DOCNUM=" + this.documento.DOCNUM + "&classifica_desc=" + classifica_desc;
                window.location.href = "protocollo?DOCNUM=" + this.documento.DOCNUM;
            },
            downloadFile: function() {
                window.location.href = "/docer/v1/documenti/"+this.documento.DOCNUM+"/file";
            },
            downloadUd: function() {
                var listaDocnum = [];
                for (var i = 0; i < this.listaAllegati.length; i++) {
                    listaDocnum.push("url=http://localhost:8082/docer/v1/documenti/"+this.listaAllegati[i].DOCNUM+"/file");
                }
                var urlForZip = listaDocnum.toString().replaceAll(",","&");
                window.location.href = "/documenti/zip?"+urlForZip;
            },
            downloadFileFromList: function(docnum) {
                window.location.href = "/docer/v1/documenti/"+docnum+"/file";
            },
            closeFirmaModal: function() {
                $( "#modalSign" ).fadeOut(500);
            },
            downloadFirmaModal: function() {
                window.location = "/docer/v1/firma/pdfReport?url="+this.documento.url;
                $( "#modalSign" ).fadeOut(500);
            },
            addTipologiaUpload: function (files) {
                if (files[0] && files[0].option==null) {
                    files[0].option = "aggiungi";
                    for (var i = 0; i < files.length; i++) {
                        if( files[i].option==null ){
                            files[i].option = "allega";
                        }
                    }
                }
                if(files.length>0){
                    $("#btn-uploadDoc").show();
                }else{
                    $("#btn-uploadDoc").hide();
                }
            },
            addTipologiaSingleUpload: function (files) {
                if (files[0] && files[0].option==null) {
                    files[0].option = "sostituisci";
                }
                if(files.length>0){
                    $("#btn-uploadNoDoc").show();
                }else{
                    $("#btn-uploadNoDoc").hide();
                }
            },
            caricaFile: function(files){
                console.log(files);
                if(files.length>0){
                    docnum = this.documento.DOCNUM;
                    var fileClient = new FileClient();
                    var file = files[0];
                    if(file.option.includes("sostituisci")){
                        axios.put("/docer/v1/documenti/"+docnum+"/fileUrl?url="+file.url)
                            .then(response => {
                                if(response.status==200){
                                    if(files.length==1){
                                        if(this.documento.SENZA_FILE=="true"){
                                            var docerClient = new DocerClient();
                                            var payload = {
                                                SENZA_FILE: "false",
                                                DOCNAME: files[0].name
                                            }
                                            var path = docnum;
                                            docerClient.documenti.update(path, payload, (data)=>{
                                                openMessageModal("Modifica avvenuta con successo!");
                                            });
                                        } else {
                                            if (this.documento.DOCNAME!=files[0].name) {
                                                this.openModalChangeName(files[0].name);
                                            } else {
                                                openMessageModal("Documento aggiornato con successo!");
                                            }
                                        }
                                    } else {
                                        this.aggiungiAllegati(files.splice(1), docnum, files[0].name);
                                    }
                                }
                            }).catch(error => {
                            showError(error.response.data);
                        });
                    } else if(file.option.includes("aggiungi")){
                        axios.post("/docer/v1/documenti/"+docnum+"/fileUrl?url="+file.url)
                            .then(response => {
                                if(response.status==200){
                                    if(files.length==1){
                                        if (this.documento.DOCNAME!=files[0].name) {
                                            this.openModalChangeName(files[0].name);
                                        } else {
                                            openMessageModal("Versione caricata con successo!");
                                        }
                                    } else {
                                        this.aggiungiAllegati(files.splice(1), docnum, files[0].name);
                                    }
                                }
                            }).catch(error => {
                            showError(error.response.data);
                        });
                    } else {
                        this.aggiungiAllegati(files, docnum, null);
                    }
                }
            },
            aggiungiAllegati: function(files, docnum, uploadedFileName) {
                var data = [{
                    DOCNUM : docnum
                }]
                for(idx in files) {
                    data.push({
                        "DOCNAME" : files[idx].name,
                        "url" : files[idx].url
                    });
                }
                axios.post("/docer/v1/documenti/multi?relate=true",data )
                    .then(response => {
                        if(response.status==201){

                            if (uploadedFileName!=null && this.documento.DOCNAME!=uploadedFileName) {
                                this.openModalChangeName(uploadedFileName);
                            } else {
                                openMessageModal("Allegati aggiunti con successo!");
                            }
                        }
                    }).catch(error => {
                    showError(error.response.data);
                });
            },
            openModalChangeName: function(newName) {
                $("#messageChangeNameModal").modal('show');
                $("#newNameChangeNameModal").val(newName);
                $('#messageChangeNameModalTxt').text("Il nome del documento caricato  diverso dal nome del documento attuale, vuoi aggiornare il nome del file con quello caricato?");
                if ($("#app-upload").is(':visible')) {
                    $('#app-upload').slideToggle("fast");
                }
                if ($("#app-upload-single").is(':visible')) {
                    $('#app-upload-single').slideToggle("fast");
                }
            },
            /*
            tipologiaChange: function () {
                var docerClient = new DocerClient();
                var payload = {
                    TYPE_ID: this.documento.TYPE_ID,
                }
                var path = this.documento.DOCNUM;
                docerClient.documenti.update(path, payload, (data)=>{
                    openMessageModal("Tipologia documento modificata con successo!");
                });
            },*/
        }
    });


    function openMessageModal(message){
        $("#messageModal").modal('show');
        $('#messageModalTxt').text(message);
        setTimeout(function(){
            $("#messageModal").modal('hide');
            $('#messageModalTxt').text("");
            window.location.reload();
        },2000);
    }

    function goToDocument(message, docnum){
        $("#messageModal").modal('show');
        $('#messageModalTxt').text(message);
        setTimeout(function(){
            $("#messageModal").modal('hide');
            $('#messageModalTxt').text("");
            window.location.href = "/documenti/viewProfile?DOCNUM="+docnum;
        },2000);
    }

    function openAnteprimaModal(message, docnum){
        $("#anteprimaModal").modal('show');
        $('#anteprimaModalTxt').text(message).css({"font-weight":"bold"});
        $('#docN').val(docnum);
    }

    $('#btn-confermaChangeName').click(function () {
        var newName = $("#newNameChangeNameModal").val();
        var docerClient = new DocerClient();
        var payload = {
            DOCNAME: newName
        }
        var path = docnum;
        docerClient.documenti.update(path, payload, (data)=>{
            $("#messageChangeNameModal").hide();
            openMessageModal("Nome Documento aggiornato con successo!");
        });
    });

    $('#btn-annullaChangeName').click(function () {
        openMessageModal("Documento caricato con successo!");
    });

    $('#btn-scaricaFile').click(function () {
        var docnum = $('#docN').val();
        window.location.href = "/docer/v1/documenti/"+docnum+"/file";
    });

    $('#btn-goToUd').click(function () {
        var docnum = $('#docNewUd').val();
        window.location.href = "/documenti/viewProfile?DOCNUM="+docnum;
    });


    $('#SelectTipoDocumento').change(function () {
        console.log( $('#SelectTipoDocumento').val() );
    });

    $('#btn-fascicola, #btn-addFasc').click(function () {
        $('.f-primario').first().css({
            "display": "block",
            "z-index": "99999",
            "margin-left": "21px"
        });
    });

    $('#btn-classifica, #btn-addCl').click(function () {
        $('.c-primaria').first().css({
            "display": "block",
            "z-index": "99999",
            "margin-left": "21px"
        });
        $('.c-secondarie').first().css({
            "display": "block",
            "z-index": "99999",
            "margin-left": "21px"
        });
        //se documento fascicolato la classifica primaria non  modificabile
        if(data("documento-model").STATO_ARCHIVISTICO=='5'){

            $('.clPrima .select2-container--default .select2-selection--multiple').css({
                "background-color": "#eee !important",
                "pointer-events": "none",
                "background-color": "#eee"
            });

        }
    });

    $('#vediAltreInfo').click(function () {
        $('#boxAltreInfo').slideToggle("fast");
    });

    $('#showUpload').click(function () {
        $('#app-upload').slideToggle("fast");
    });

    $('#showUploadSingle').click(function () {
        $('#app-upload-single').slideToggle("fast");
    });

    $('#btn-switchHtml').click(function () {
        //$('#close-preview').trigger("click");
        $( "#modalPreviewPdf" ).hide();
    });

    $('#classificaNF').removeAttr("disabled");


    var slider = document.getElementById("pagesSlide");
    var output = document.getElementById("paginaDocumento");
    output.innerHTML = slider.value;

    slider.oninput = function() {
        output.innerHTML = this.value;
    }

    var currentCodiceAOO = '${$.userInfo.aoo.cod}';
    var currentDenominazioneAOO = '${$.userInfo.aoo.desc}';
    var currentCodiceAmm = '${$.userInfo.ente.cod}';
    var currentDenominazioneAmm = '${$.userInfo.ente.desc}';
    var utenteLoggato = '${$.userInfo.username}';

    var estensioniSupportate = "xml,pdf,p7m";
    //se il documento  protocollato o registrato
    if (documento.NUM_PG||documento.N_REGISTRAZ) {
        //abilito tasto Stampiglia solo se il file  protocollato e ha un'estensione supportata
        var btnStampigliaturaEnabled = false;
        var estensioneFile = documento.DOCNAME.substring(documento.DOCNAME.toLowerCase().lastIndexOf(".")+1);
        var estensioneSupportata = estensioniSupportate.toLowerCase().split(",");
        for(i=0;i<estensioneSupportata.length;i++) {
            var ext = estensioneSupportata[i];
            if (estensioneFile == ext) {
                btnStampigliaturaEnabled = true;
            }
        }
        if(btnStampigliaturaEnabled==true){
            $('#creaStampigliatura').show();
        }else{
            $('#creaStampigliatura').hide();
        }
    } else {
        $('#creaStampigliatura').hide();
    }

    let url_string = window.location.href;
    var url = new URL(url_string);
    var paramFromEditUd = url.searchParams.get("EDIT_UD");
    if(paramFromEditUd=="edit"){
        $('#btn-edit').trigger("click");
    }

</script>

</body>

</html>